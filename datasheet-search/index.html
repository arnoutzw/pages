<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Datasheet Search</title>
<style>
:root {
  --bg-0: #09090b;
  --bg-1: #18181b;
  --bg-2: #27272a;
  --bg-3: #3f3f46;
  --tx-1: #f4f4f5;
  --tx-2: #a1a1aa;
  --tx-3: #71717a;
  --accent: #f59e0b;
  --accent-h: #d97706;
  --accent-bg: rgba(245,158,11,.12);
  --danger: #ef4444;
  --success: #22c55e;
  --border: #27272a;
  --radius: 8px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-0);
  color: var(--tx-1);
  min-height: 100vh;
}

/* Header */
.header {
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  text-align: center;
}
.header h1 {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.header p {
  font-size: 12px;
  color: var(--tx-3);
}

/* Mode selector row */
.mode-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 10px;
}
.mode-pills {
  display: inline-flex;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--bg-3);
}
.mode-pill {
  padding: 5px 14px;
  font-size: 11px;
  font-weight: 600;
  background: var(--bg-2);
  color: var(--tx-3);
  border: none;
  cursor: pointer;
  transition: all .15s;
  white-space: nowrap;
}
.mode-pill:not(:last-child) { border-right: 1px solid var(--bg-3); }
.mode-pill:hover { color: var(--tx-2); background: var(--bg-3); }
.mode-pill.active { background: var(--accent); color: var(--bg-0); }
.api-settings-btn {
  background: none;
  border: 1px solid var(--bg-3);
  border-radius: 6px;
  color: var(--tx-3);
  font-size: 14px;
  cursor: pointer;
  width: 28px;
  height: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all .15s;
}
.api-settings-btn:hover { border-color: var(--accent); color: var(--accent); }
.api-settings-btn.configured { color: var(--success); border-color: var(--success); }
.api-settings-btn.locked { opacity: .4; cursor: not-allowed; }
.api-settings-btn.locked:hover { border-color: var(--bg-3); color: var(--tx-3); }
.admin-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .05em;
  color: var(--accent);
  background: var(--accent-bg);
  border: 1px solid rgba(245,158,11,.25);
  padding: 3px 8px;
  border-radius: 4px;
}

/* Search */
.search-wrap {
  max-width: 720px;
  margin: 24px auto 0;
  padding: 0 16px;
}
.search-box {
  display: flex;
  gap: 8px;
}
.search-box input {
  flex: 1;
  padding: 12px 16px;
  background: var(--bg-1);
  border: 1px solid var(--bg-3);
  border-radius: var(--radius);
  color: var(--tx-1);
  font-size: 15px;
  outline: none;
  transition: border-color .15s;
}
.search-box input::placeholder { color: var(--tx-3); }
.search-box input:focus { border-color: var(--accent); }
.search-box button {
  padding: 12px 24px;
  background: var(--accent);
  color: var(--bg-0);
  border: none;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: background .15s;
}
.search-box button:hover { background: var(--accent-h); }
.search-box button:disabled { opacity: .5; cursor: not-allowed; }
.search-hint {
  font-size: 11px;
  color: var(--tx-3);
  margin-top: 8px;
  text-align: center;
}

/* Tabs */
.tabs {
  max-width: 720px;
  margin: 20px auto 0;
  padding: 0 16px;
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--border);
}
.tab-btn {
  padding: 8px 16px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--tx-3);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
}
.tab-btn:hover { color: var(--tx-2); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

/* Content */
.content {
  max-width: 720px;
  margin: 0 auto;
  padding: 16px;
}
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Quick search categories */
.cat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 10px;
}
.cat-card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  cursor: pointer;
  transition: all .15s;
}
.cat-card:hover { border-color: var(--accent); background: var(--accent-bg); }
.cat-card h3 {
  font-size: 13px;
  font-weight: 600;
  color: var(--tx-1);
  margin-bottom: 4px;
}
.cat-card p {
  font-size: 11px;
  color: var(--tx-3);
  line-height: 1.4;
}
.cat-card .cat-icon {
  font-size: 18px;
  margin-bottom: 6px;
}

/* Common parts */
.parts-section {
  margin-bottom: 20px;
}
.parts-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--tx-3);
  margin-bottom: 8px;
}
.parts-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.part-chip {
  padding: 5px 12px;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 12px;
  color: var(--tx-2);
  cursor: pointer;
  transition: all .12s;
  font-family: 'Courier New', monospace;
  font-weight: 500;
}
.part-chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }

/* History / Bookmarks list */
.list-empty {
  text-align: center;
  padding: 32px 16px;
  color: var(--tx-3);
  font-size: 13px;
}
.list-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 6px;
  transition: border-color .12s;
}
.list-item:hover { border-color: var(--bg-3); }
.list-item-text {
  flex: 1;
  min-width: 0;
}
.list-item-query {
  font-size: 14px;
  font-weight: 600;
  color: var(--tx-1);
  font-family: 'Courier New', monospace;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.list-item-meta {
  font-size: 11px;
  color: var(--tx-3);
  margin-top: 2px;
}
.list-item-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}
.icon-btn {
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-2);
  border: none;
  border-radius: 6px;
  color: var(--tx-3);
  cursor: pointer;
  font-size: 14px;
  transition: all .12s;
}
.icon-btn:hover { background: var(--bg-3); color: var(--tx-1); }
.icon-btn.bookmarked { color: var(--accent); }
.icon-btn.danger:hover { color: var(--danger); }
.clear-btn {
  display: block;
  margin: 12px auto 0;
  padding: 6px 16px;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--tx-3);
  font-size: 12px;
  cursor: pointer;
}
.clear-btn:hover { border-color: var(--danger); color: var(--danger); }

/* Results status (link mode) */
.search-status {
  text-align: center;
  padding: 20px;
  font-size: 13px;
  color: var(--tx-3);
}
.search-status a {
  color: var(--accent);
  text-decoration: none;
}
.search-status a:hover { text-decoration: underline; }

/* Source badges */
.source-row {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 12px;
  flex-wrap: wrap;
}
.source-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--tx-2);
  font-size: 13px;
  font-weight: 500;
  text-decoration: none;
  transition: all .15s;
}
.source-link:hover { border-color: var(--accent); color: var(--accent); }
.source-link .arrow { font-size: 11px; opacity: .6; }

/* â”€â”€ NEXAR API results â”€â”€ */
.api-results-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.api-results-header h3 {
  font-size: 14px;
  font-weight: 600;
  color: var(--tx-2);
}
.api-results-header .hits {
  font-size: 12px;
  color: var(--tx-3);
}
.api-loading {
  text-align: center;
  padding: 40px 16px;
  color: var(--tx-3);
}
.api-loading .spinner {
  display: inline-block;
  width: 24px;
  height: 24px;
  border: 3px solid var(--bg-3);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  margin-bottom: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.api-error {
  text-align: center;
  padding: 24px 16px;
  color: var(--danger);
  font-size: 13px;
  background: rgba(239,68,68,.08);
  border: 1px solid rgba(239,68,68,.2);
  border-radius: var(--radius);
}
.api-error code {
  display: block;
  margin-top: 6px;
  font-size: 11px;
  color: var(--tx-3);
  word-break: break-all;
}

/* Part card */
.part-card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 10px;
  transition: border-color .15s;
}
.part-card:hover { border-color: var(--bg-3); }
.part-card-head {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 8px;
}
.part-card-info { flex: 1; min-width: 0; }
.part-card-mpn {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent);
  font-family: 'Courier New', monospace;
}
.part-card-mfr {
  font-size: 12px;
  color: var(--tx-3);
  margin-top: 2px;
}
.part-card-desc {
  font-size: 13px;
  color: var(--tx-2);
  margin-top: 6px;
  line-height: 1.4;
}
.part-card-img {
  width: 56px;
  height: 56px;
  border-radius: 6px;
  background: var(--bg-2);
  object-fit: contain;
  flex-shrink: 0;
}
.part-card-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}
.ds-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 6px 14px;
  background: var(--accent);
  color: var(--bg-0);
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: background .15s;
}
.ds-btn:hover { background: var(--accent-h); }
.ds-btn svg { width: 14px; height: 14px; }
.ds-btn-outline {
  background: transparent;
  color: var(--tx-2);
  border: 1px solid var(--bg-3);
}
.ds-btn-outline:hover { border-color: var(--accent); color: var(--accent); background: transparent; }
.part-specs {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.spec-tag {
  font-size: 11px;
  padding: 3px 8px;
  background: var(--bg-2);
  border-radius: 4px;
  color: var(--tx-3);
}
.spec-tag b { color: var(--tx-2); font-weight: 600; }
.part-card-cat {
  font-size: 11px;
  color: var(--tx-3);
  margin-top: 6px;
}

/* Modal */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-bg.active { display: flex; }
.modal {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 420px;
}
.modal h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--tx-1);
  margin-bottom: 4px;
}
.modal .modal-desc {
  font-size: 12px;
  color: var(--tx-3);
  margin-bottom: 16px;
  line-height: 1.5;
}
.modal label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--tx-2);
  margin-bottom: 4px;
  margin-top: 12px;
}
.modal label:first-of-type { margin-top: 0; }
.modal input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-2);
  border: 1px solid var(--bg-3);
  border-radius: 6px;
  color: var(--tx-1);
  font-size: 13px;
  font-family: 'Courier New', monospace;
  outline: none;
}
.modal input:focus { border-color: var(--accent); }
.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}
.modal-actions button {
  padding: 8px 18px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
}
.modal-actions .btn-save { background: var(--accent); color: var(--bg-0); }
.modal-actions .btn-save:hover { background: var(--accent-h); }
.modal-actions .btn-cancel { background: var(--bg-2); color: var(--tx-2); }
.modal-actions .btn-cancel:hover { background: var(--bg-3); color: var(--tx-1); }
.modal-actions .btn-clear { background: none; color: var(--danger); border: 1px solid var(--danger); }
.modal-actions .btn-clear:hover { background: var(--danger); color: var(--tx-1); }
.modal-status {
  font-size: 11px;
  margin-top: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  display: none;
}
.modal-status.ok { display: block; background: rgba(34,197,94,.1); color: var(--success); border: 1px solid rgba(34,197,94,.2); }
.modal-status.err { display: block; background: rgba(239,68,68,.1); color: var(--danger); border: 1px solid rgba(239,68,68,.2); }

@media (max-width: 480px) {
  .cat-grid { grid-template-columns: 1fr 1fr; }
  .search-box { flex-direction: column; }
  .search-box button { width: 100%; }
  .header { padding: 12px 16px; }
}
</style>
</head>
<body>

<div class="header">
  <h1>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    Datasheet Search
  </h1>
  <p>Search electronic component datasheets across multiple sources</p>
  <div class="mode-row">
    <div class="mode-pills" id="mode-pills">
      <button class="mode-pill active" data-mode="link">Links</button>
      <button class="mode-pill" data-mode="nexar">NEXAR</button>
      <button class="mode-pill" data-mode="trustedparts">TrustedParts</button>
    </div>
    <button class="api-settings-btn" id="btn-api-settings" title="API Settings (Admin only)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
    <span class="admin-badge" id="admin-badge" style="display:none">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      Admin
    </span>
  </div>
</div>

<div class="search-wrap">
  <div class="search-box">
    <input type="text" id="search-input" placeholder="Enter part number (e.g. LM7805, ATmega328P, NE555)..." autofocus>
    <button id="btn-search">Search</button>
  </div>
  <div class="search-hint" id="search-hint">Press Enter to search &bull; Results open on datasheet provider sites</div>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="browse">Browse</button>
  <button class="tab-btn" data-tab="history">History</button>
  <button class="tab-btn" data-tab="bookmarks">Bookmarks</button>
</div>

<div class="content">

  <!-- Browse tab -->
  <div class="tab-panel active" id="tab-browse">

    <div id="search-results" style="display:none"></div>

    <div id="browse-content">
      <div class="parts-section">
        <div class="parts-title">Popular Components</div>
        <div class="parts-chips" id="popular-chips"></div>
      </div>

      <div class="parts-section">
        <div class="parts-title">Quick Categories</div>
        <div class="cat-grid" id="cat-grid"></div>
      </div>
    </div>
  </div>

  <!-- History tab -->
  <div class="tab-panel" id="tab-history">
    <div id="history-list"></div>
  </div>

  <!-- Bookmarks tab -->
  <div class="tab-panel" id="tab-bookmarks">
    <div id="bookmarks-list"></div>
  </div>

</div>

<!-- API Settings Modal -->
<div class="modal-bg" id="settings-modal">
  <div class="modal" style="max-width:460px">
    <h3>API Settings</h3>
    <p class="modal-desc">
      Credentials are <strong style="color:var(--success)">AES-256-GCM encrypted</strong> with your admin password before storage.
    </p>
    <div class="modal-tabs" style="display:flex;gap:4px;margin-bottom:14px;border-bottom:1px solid var(--border);padding-bottom:8px">
      <button class="tab-btn active" data-cfg-tab="nexar" id="cfg-tab-nexar" style="padding:5px 12px;font-size:12px">NEXAR</button>
      <button class="tab-btn" data-cfg-tab="trustedparts" id="cfg-tab-tp" style="padding:5px 12px;font-size:12px">TrustedParts</button>
    </div>
    <!-- NEXAR fields -->
    <div id="cfg-panel-nexar">
      <p style="font-size:11px;color:var(--tx-3);margin-bottom:10px">
        GraphQL API for parts &amp; datasheets. Free at <a href="https://nexar.com/api" target="_blank" rel="noopener" style="color:var(--accent)">nexar.com/api</a>
      </p>
      <label for="cfg-nexar-id">Client ID</label>
      <input type="text" id="cfg-nexar-id" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
      <label for="cfg-nexar-secret">Client Secret</label>
      <input type="password" id="cfg-nexar-secret" placeholder="Client secret" autocomplete="off">
    </div>
    <!-- TrustedParts fields -->
    <div id="cfg-panel-tp" style="display:none">
      <p style="font-size:11px;color:var(--tx-3);margin-bottom:10px">
        Authorized distributor inventory. Free at <a href="https://www.trustedparts.com/docs/trustedparts-api/credentials/" target="_blank" rel="noopener" style="color:var(--accent)">trustedparts.com</a>
      </p>
      <label for="cfg-tp-company">Company ID</label>
      <input type="text" id="cfg-tp-company" placeholder="Your Company ID" autocomplete="off">
      <label for="cfg-tp-key">API Key</label>
      <input type="password" id="cfg-tp-key" placeholder="Your API Key" autocomplete="off">
    </div>
    <div class="modal-status" id="settings-status"></div>
    <div class="modal-actions">
      <button class="btn-clear" id="btn-cfg-clear">Clear</button>
      <button class="btn-cancel" id="btn-cfg-cancel">Cancel</button>
      <button class="btn-save" id="btn-cfg-save">Save &amp; Encrypt</button>
    </div>
  </div>
</div>

<script>
// ===================================================================
// DATASHEET SEARCH APP â€” Link Mode + NEXAR API + TrustedParts API
// Credentials encrypted with AES-256-GCM, admin-only access
// ===================================================================

const STORAGE_KEYS = {
  history: 'ds-search-history',
  bookmarks: 'ds-search-bookmarks',
  mode: 'ds-search-mode',
  nexarEncrypted: 'ds-nexar-encrypted',
  tpEncrypted: 'ds-tp-encrypted',
};

// â”€â”€ NEXAR API Config â”€â”€
const NEXAR_TOKEN_URL = 'https://identity.nexar.com/connect/token';
const NEXAR_GQL_URL   = 'https://api.nexar.com/graphql';

const NEXAR_QUERY = `
query SearchParts($q: String!) {
  supSearchMpn(q: $q, limit: 10) {
    hits
    results {
      part {
        mpn
        manufacturer { name }
        shortDescription
        category { name path }
        bestDatasheet { url name }
        specs {
          attribute { name shortname }
          displayValue
        }
        images { url }
      }
    }
  }
}`;

// â”€â”€ TrustedParts API Config â”€â”€
const TP_SEARCH_URL = 'https://api.trustedparts.com/v2/search';

// â”€â”€ Link-mode Sources â”€â”€
const SOURCES = [
  { name: 'AllDatasheet',    url: 'https://www.alldatasheet.com/view.jsp?Searchword={q}',   icon: 'ðŸ“„' },
  { name: 'Datasheet Archive', url: 'https://www.datasheetarchive.com/search?q={q}',          icon: 'ðŸ—„ï¸' },
  { name: 'Octopart',        url: 'https://octopart.com/search?q={q}',                      icon: 'ðŸ”' },
  { name: 'DigiKey',         url: 'https://www.digikey.com/en/products/result?keywords={q}', icon: 'ðŸ›’' },
  { name: 'Mouser',          url: 'https://www.mouser.com/c/?q={q}',                        icon: 'ðŸ›’' },
  { name: 'LCSC',            url: 'https://www.lcsc.com/search?q={q}',                      icon: 'ðŸ›’' },
];

const POPULAR = [
  'NE555','LM7805','LM317','ATmega328P','ESP32','STM32F103',
  'LM358','TL072','LM393','IRF540N','TIP120','2N2222',
  'AMS1117-3.3','MCP2515','MAX232','74HC595','CD4017','LM386',
  'W25Q128','ADS1115','BME280','MPU6050','INA219','TPS63020',
];

const CATEGORIES = [
  { icon: 'âš¡', title: 'Voltage Regulators', desc: 'Linear & switching regulators', parts: ['LM7805','LM317','AMS1117','TPS63020','LM2596','AP2112'] },
  { icon: 'ðŸ”Š', title: 'Op-Amps & Audio', desc: 'Operational amplifiers, audio ICs', parts: ['LM358','TL072','NE5532','LM386','TDA2030','LM4871'] },
  { icon: 'ðŸ§ ', title: 'Microcontrollers', desc: 'MCUs and development chips', parts: ['ATmega328P','ESP32','STM32F103','PIC16F877','RP2040','ATTINY85'] },
  { icon: 'ðŸ“¡', title: 'Communication', desc: 'UART, SPI, I2C, CAN, RF', parts: ['MAX232','MCP2515','MCP2551','NRF24L01','CC1101','SX1276'] },
  { icon: 'ðŸ’¡', title: 'LED Drivers', desc: 'Constant current & PWM drivers', parts: ['WS2812B','TLC5940','PCA9685','AL8805','PT4115','CAT4101'] },
  { icon: 'ðŸ”Œ', title: 'Transistors & MOSFETs', desc: 'BJTs, MOSFETs, IGBTs', parts: ['2N2222','BC547','IRF540N','IRFZ44N','TIP120','IRF3205'] },
  { icon: 'ðŸ“', title: 'Sensors', desc: 'Temperature, motion, pressure', parts: ['BME280','MPU6050','DHT22','DS18B20','BMP280','ADXL345'] },
  { icon: 'ðŸ’¾', title: 'Memory & Storage', desc: 'EEPROM, Flash, SRAM', parts: ['W25Q128','AT24C256','23LC1024','IS62WV1288','SST39SF040','M25P16'] },
  { icon: 'â±ï¸', title: 'Timers & Logic', desc: '555 timers, logic gates, counters', parts: ['NE555','74HC595','CD4017','74HC245','SN74LVC1G14','CD4051'] },
  { icon: 'ðŸ”‹', title: 'Power Management', desc: 'Battery chargers, converters', parts: ['TP4056','BQ24195','TPS54331','INA219','MAX17048','LTC3780'] },
];

// â”€â”€ State â”€â”€
let searchHistory = JSON.parse(localStorage.getItem(STORAGE_KEYS.history) || '[]');
let bookmarks = JSON.parse(localStorage.getItem(STORAGE_KEYS.bookmarks) || '[]');
let searchMode = localStorage.getItem(STORAGE_KEYS.mode) || 'link'; // 'link' | 'nexar' | 'trustedparts'
let nexarToken = null;
let nexarTokenExp = 0;
let searching = false;

// Admin auth state (received from parent via postMessage)
let adminKey = null;
let isAdmin = false;
// Decrypted credentials (in-memory only while admin is logged in)
let nexarCreds = null;  // { clientId, clientSecret }
let tpCreds = null;     // { companyId, apiKey }

function saveHistory() { localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(searchHistory)); }
function saveBookmarks() { localStorage.setItem(STORAGE_KEYS.bookmarks, JSON.stringify(bookmarks)); }

// â”€â”€ AES-256-GCM Encryption (Web Crypto API) â”€â”€
const CRYPTO_SALT_LEN = 16;
const CRYPTO_IV_LEN = 12;
const CRYPTO_ITER = 310000;

async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
  );
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: CRYPTO_ITER, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function encryptData(password, plaintext) {
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(CRYPTO_SALT_LEN));
  const iv   = crypto.getRandomValues(new Uint8Array(CRYPTO_IV_LEN));
  const key  = await deriveKey(password, salt);
  const ct   = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(plaintext));
  // Pack: salt(16) + iv(12) + ciphertext
  const buf = new Uint8Array(salt.length + iv.length + ct.byteLength);
  buf.set(salt, 0);
  buf.set(iv, salt.length);
  buf.set(new Uint8Array(ct), salt.length + iv.length);
  return btoa(String.fromCharCode(...buf));
}

async function decryptData(password, b64) {
  const raw = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  const salt = raw.slice(0, CRYPTO_SALT_LEN);
  const iv   = raw.slice(CRYPTO_SALT_LEN, CRYPTO_SALT_LEN + CRYPTO_IV_LEN);
  const ct   = raw.slice(CRYPTO_SALT_LEN + CRYPTO_IV_LEN);
  const key  = await deriveKey(password, salt);
  const pt   = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
  return new TextDecoder().decode(pt);
}

// â”€â”€ Credential helpers â”€â”€
async function saveEncrypted(storageKey, data) {
  if (!adminKey) throw new Error('Admin login required');
  const encrypted = await encryptData(adminKey, JSON.stringify(data));
  localStorage.setItem(storageKey, encrypted);
}

async function loadEncrypted(storageKey) {
  if (!adminKey) return null;
  const b64 = localStorage.getItem(storageKey);
  if (!b64) return null;
  try { return JSON.parse(await decryptData(adminKey, b64)); }
  catch { return null; }
}

function clearAllCredentials() {
  localStorage.removeItem(STORAGE_KEYS.nexarEncrypted);
  localStorage.removeItem(STORAGE_KEYS.tpEncrypted);
  nexarCreds = null;
  tpCreds = null;
  nexarToken = null;
  nexarTokenExp = 0;
}

// â”€â”€ DOM refs â”€â”€
const modePills  = document.getElementById('mode-pills');
const searchHint  = document.getElementById('search-hint');
const btnSettings = document.getElementById('btn-api-settings');
const settingsModal = document.getElementById('settings-modal');
const btnSearch   = document.getElementById('btn-search');
const adminBadge  = document.getElementById('admin-badge');

// â”€â”€ Admin auth via postMessage â”€â”€
window.addEventListener('message', async (e) => {
  if (!e.data || e.data.type !== 'admin-auth') return;
  isAdmin = !!e.data.isAdmin;
  adminKey = e.data.key || null;
  adminBadge.style.display = isAdmin ? '' : 'none';
  btnSettings.classList.toggle('locked', !isAdmin);

  if (isAdmin && adminKey) {
    nexarCreds = await loadEncrypted(STORAGE_KEYS.nexarEncrypted);
    tpCreds = await loadEncrypted(STORAGE_KEYS.tpEncrypted);
  } else {
    nexarCreds = null;
    tpCreds = null;
    nexarToken = null;
    nexarTokenExp = 0;
  }
  updateModeUI();
});

// â”€â”€ Mode Selector â”€â”€
function updateModeUI() {
  modePills.querySelectorAll('.mode-pill').forEach(b =>
    b.classList.toggle('active', b.dataset.mode === searchMode)
  );
  const hints = {
    link: 'Press Enter to search \u2022 Results open on datasheet provider sites',
    nexar: 'Press Enter to search via NEXAR API',
    trustedparts: 'Press Enter to search via TrustedParts API',
  };
  searchHint.textContent = hints[searchMode] || hints.link;
  const hasAnyCreds = isAdmin && (!!nexarCreds || !!tpCreds);
  btnSettings.classList.toggle('configured', hasAnyCreds);
}

modePills.addEventListener('click', (e) => {
  const pill = e.target.closest('.mode-pill');
  if (!pill) return;
  searchMode = pill.dataset.mode;
  localStorage.setItem(STORAGE_KEYS.mode, searchMode);
  updateModeUI();
  if (searchMode === 'nexar' && !nexarCreds && isAdmin) openSettings('nexar');
  if (searchMode === 'trustedparts' && !tpCreds && isAdmin) openSettings('trustedparts');
});

// â”€â”€ Settings Modal â”€â”€
let cfgActiveTab = 'nexar';

function switchCfgTab(tab) {
  cfgActiveTab = tab;
  document.getElementById('cfg-panel-nexar').style.display = tab === 'nexar' ? '' : 'none';
  document.getElementById('cfg-panel-tp').style.display = tab === 'trustedparts' ? '' : 'none';
  document.getElementById('cfg-tab-nexar').classList.toggle('active', tab === 'nexar');
  document.getElementById('cfg-tab-tp').classList.toggle('active', tab === 'trustedparts');
}

document.getElementById('cfg-tab-nexar').addEventListener('click', () => switchCfgTab('nexar'));
document.getElementById('cfg-tab-tp').addEventListener('click', () => switchCfgTab('trustedparts'));

async function openSettings(tab) {
  if (!isAdmin) {
    alert('Admin login required to manage API credentials.\nLog in as admin on the main page first.');
    return;
  }
  switchCfgTab(tab || cfgActiveTab);
  // Populate NEXAR fields
  const nc = nexarCreds || await loadEncrypted(STORAGE_KEYS.nexarEncrypted);
  document.getElementById('cfg-nexar-id').value = nc?.clientId || '';
  document.getElementById('cfg-nexar-secret').value = nc?.clientSecret || '';
  // Populate TrustedParts fields
  const tc = tpCreds || await loadEncrypted(STORAGE_KEYS.tpEncrypted);
  document.getElementById('cfg-tp-company').value = tc?.companyId || '';
  document.getElementById('cfg-tp-key').value = tc?.apiKey || '';

  const st = document.getElementById('settings-status');
  st.className = 'modal-status'; st.style.display = 'none';
  settingsModal.classList.add('active');
}

btnSettings.addEventListener('click', () => openSettings());
document.getElementById('btn-cfg-cancel').addEventListener('click', () => settingsModal.classList.remove('active'));
document.getElementById('btn-cfg-clear').addEventListener('click', () => {
  if (cfgActiveTab === 'nexar') {
    localStorage.removeItem(STORAGE_KEYS.nexarEncrypted);
    nexarCreds = null; nexarToken = null; nexarTokenExp = 0;
    document.getElementById('cfg-nexar-id').value = '';
    document.getElementById('cfg-nexar-secret').value = '';
  } else {
    localStorage.removeItem(STORAGE_KEYS.tpEncrypted);
    tpCreds = null;
    document.getElementById('cfg-tp-company').value = '';
    document.getElementById('cfg-tp-key').value = '';
  }
  const st = document.getElementById('settings-status');
  st.textContent = (cfgActiveTab === 'nexar' ? 'NEXAR' : 'TrustedParts') + ' credentials cleared.';
  st.className = 'modal-status ok';
  updateModeUI();
});

document.getElementById('btn-cfg-save').addEventListener('click', async () => {
  const st = document.getElementById('settings-status');
  if (!isAdmin || !adminKey) {
    st.textContent = 'Admin login required to save credentials.';
    st.className = 'modal-status err';
    return;
  }

  if (cfgActiveTab === 'nexar') {
    const id = document.getElementById('cfg-nexar-id').value.trim();
    const secret = document.getElementById('cfg-nexar-secret').value.trim();
    if (!id || !secret) { st.textContent = 'Both Client ID and Client Secret are required.'; st.className = 'modal-status err'; return; }
    st.textContent = 'Testing NEXAR connection...'; st.className = 'modal-status ok';
    try {
      await fetchNexarToken(id, secret);
      await saveEncrypted(STORAGE_KEYS.nexarEncrypted, { clientId: id, clientSecret: secret });
      nexarCreds = { clientId: id, clientSecret: secret };
      st.textContent = 'NEXAR connected & encrypted!'; st.className = 'modal-status ok';
      updateModeUI();
      setTimeout(() => settingsModal.classList.remove('active'), 1200);
    } catch (e) { st.textContent = 'NEXAR failed: ' + e.message; st.className = 'modal-status err'; }
  } else {
    const companyId = document.getElementById('cfg-tp-company').value.trim();
    const apiKey = document.getElementById('cfg-tp-key').value.trim();
    if (!companyId || !apiKey) { st.textContent = 'Both Company ID and API Key are required.'; st.className = 'modal-status err'; return; }
    st.textContent = 'Saving TrustedParts credentials...'; st.className = 'modal-status ok';
    try {
      await saveEncrypted(STORAGE_KEYS.tpEncrypted, { companyId, apiKey });
      tpCreds = { companyId, apiKey };
      st.textContent = 'TrustedParts credentials encrypted & saved!'; st.className = 'modal-status ok';
      updateModeUI();
      setTimeout(() => settingsModal.classList.remove('active'), 1200);
    } catch (e) { st.textContent = 'Failed: ' + e.message; st.className = 'modal-status err'; }
  }
});

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && settingsModal.classList.contains('active')) {
    settingsModal.classList.remove('active');
  }
});

// â”€â”€ NEXAR API â”€â”€
async function fetchNexarToken(clientId, clientSecret) {
  const body = new URLSearchParams({
    grant_type: 'client_credentials',
    client_id: clientId,
    client_secret: clientSecret,
  });
  const res = await fetch(NEXAR_TOKEN_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body,
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`Token request failed (${res.status})`);
  }
  const data = await res.json();
  nexarToken = data.access_token;
  nexarTokenExp = Date.now() + (data.expires_in - 60) * 1000; // 1min buffer
  return nexarToken;
}

async function getToken() {
  if (nexarToken && Date.now() < nexarTokenExp) return nexarToken;
  if (!nexarCreds) {
    if (!isAdmin || !adminKey) throw new Error('Admin login required to use NEXAR API');
    nexarCreds = await loadEncrypted(STORAGE_KEYS.nexarEncrypted);
    if (!nexarCreds) throw new Error('NEXAR API credentials not configured. Open Settings to add them.');
  }
  return fetchNexarToken(nexarCreds.clientId, nexarCreds.clientSecret);
}

async function nexarSearch(query) {
  const token = await getToken();
  const res = await fetch(NEXAR_GQL_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token,
    },
    body: JSON.stringify({ query: NEXAR_QUERY, variables: { q: query } }),
  });
  if (!res.ok) {
    throw new Error(`API request failed (${res.status})`);
  }
  const data = await res.json();
  if (data.errors) {
    throw new Error(data.errors.map(e => e.message).join('; '));
  }
  return data.data.supSearchMpn;
}

// â”€â”€ Search Dispatcher â”€â”€
async function doSearch(query) {
  query = query.trim();
  if (!query || searching) return;

  document.getElementById('search-input').value = query;

  // Add to history
  searchHistory = searchHistory.filter(h => h.query.toLowerCase() !== query.toLowerCase());
  searchHistory.unshift({ query, timestamp: Date.now() });
  if (searchHistory.length > 50) searchHistory.length = 50;
  saveHistory();

  switchTab('browse');

  if (searchMode === 'nexar') {
    await doNexarSearch(query);
  } else if (searchMode === 'trustedparts') {
    await doTpSearch(query);
  } else {
    doLinkSearch(query);
  }
}

// â”€â”€ Link Mode Search â”€â”€
function doLinkSearch(query) {
  showLinkResults(query);
  window.open(SOURCES[0].url.replace('{q}', encodeURIComponent(query)), '_blank');
}

function showLinkResults(query) {
  const resultsEl = document.getElementById('search-results');
  const browseEl = document.getElementById('browse-content');
  const isBookmarked = bookmarks.some(b => b.query.toLowerCase() === query.toLowerCase());

  let html = `<div class="search-status">
    <p>Searching for <strong style="color:var(--accent);font-family:'Courier New',monospace">${escHtml(query)}</strong></p>
    <p style="margin-top:4px">AllDatasheet opened in a new tab.
      <button class="icon-btn${isBookmarked ? ' bookmarked' : ''}" onclick="toggleBookmark('${escAttr(query)}')" title="${isBookmarked ? 'Remove bookmark' : 'Bookmark this search'}" style="display:inline-flex;vertical-align:middle;margin-left:4px">${isBookmarked ? 'â˜…' : 'â˜†'}</button>
    </p>
  </div>`;
  html += '<div class="source-row">';
  for (const src of SOURCES) {
    const url = src.url.replace('{q}', encodeURIComponent(query));
    html += `<a href="${url}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
  }
  html += '</div>';

  resultsEl.innerHTML = html;
  resultsEl.style.display = 'block';
  browseEl.style.display = 'none';
}

// â”€â”€ NEXAR Mode Search â”€â”€
async function doNexarSearch(query) {
  const resultsEl = document.getElementById('search-results');
  const browseEl = document.getElementById('browse-content');
  searching = true;
  btnSearch.disabled = true;

  resultsEl.innerHTML = `<div class="api-loading"><div class="spinner"></div><div>Searching NEXAR for <strong style="color:var(--accent);font-family:monospace">${escHtml(query)}</strong>...</div></div>`;
  resultsEl.style.display = 'block';
  browseEl.style.display = 'none';

  try {
    const data = await nexarSearch(query);
    renderApiResults(query, data);
  } catch (e) {
    resultsEl.innerHTML = `<div class="api-error">Search failed: ${escHtml(e.message)}<code>Check your API credentials in Settings, or switch to Link Mode.</code></div>`;
  } finally {
    searching = false;
    btnSearch.disabled = false;
  }
}

function renderApiResults(query, data) {
  const resultsEl = document.getElementById('search-results');
  const results = data.results || [];
  const isBookmarked = bookmarks.some(b => b.query.toLowerCase() === query.toLowerCase());

  let html = `<div class="api-results-header">
    <h3>Results for <span style="color:var(--accent);font-family:'Courier New',monospace">${escHtml(query)}</span>
      <button class="icon-btn${isBookmarked ? ' bookmarked' : ''}" onclick="toggleBookmark('${escAttr(query)}')" title="Bookmark" style="display:inline-flex;vertical-align:middle;margin-left:4px;width:24px;height:24px;font-size:13px">${isBookmarked ? 'â˜…' : 'â˜†'}</button>
    </h3>
    <span class="hits">${data.hits || 0} total hits</span>
  </div>`;

  if (results.length === 0) {
    html += `<div class="list-empty">No parts found for "${escHtml(query)}".<br>Try a different part number or switch to Link Mode.</div>`;
    // Show link fallback
    html += '<div class="source-row" style="margin-top:16px">';
    for (const src of SOURCES) {
      html += `<a href="${src.url.replace('{q}', encodeURIComponent(query))}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
    }
    html += '</div>';
  } else {
    for (const r of results) {
      const p = r.part;
      html += renderPartCard(p, query);
    }
    // Also show link sources at bottom
    html += '<div style="margin-top:16px"><div class="parts-title">Also search on</div><div class="source-row" style="justify-content:flex-start">';
    for (const src of SOURCES) {
      html += `<a href="${src.url.replace('{q}', encodeURIComponent(query))}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
    }
    html += '</div></div>';
  }

  resultsEl.innerHTML = html;
}

function renderPartCard(p, query) {
  const mfr = p.manufacturer?.name || 'Unknown';
  const desc = p.shortDescription || '';
  const ds = p.bestDatasheet;
  const img = p.images?.[0]?.url;
  const cat = p.category?.name || '';
  const catPath = p.category?.path || '';
  const specs = (p.specs || []).slice(0, 8);

  let html = `<div class="part-card">
    <div class="part-card-head">
      <div class="part-card-info">
        <div class="part-card-mpn">${escHtml(p.mpn || '')}</div>
        <div class="part-card-mfr">${escHtml(mfr)}</div>
        ${desc ? `<div class="part-card-desc">${escHtml(desc)}</div>` : ''}
        ${cat ? `<div class="part-card-cat">${escHtml(catPath || cat)}</div>` : ''}
      </div>
      ${img ? `<img class="part-card-img" src="${escHtml(img)}" alt="${escHtml(p.mpn)}" onerror="this.style.display='none'">` : ''}
    </div>`;

  if (specs.length) {
    html += '<div class="part-specs">';
    for (const s of specs) {
      const name = s.attribute?.shortname || s.attribute?.name || '';
      html += `<span class="spec-tag"><b>${escHtml(name)}</b> ${escHtml(s.displayValue || '')}</span>`;
    }
    html += '</div>';
  }

  html += '<div class="part-card-actions">';
  if (ds?.url) {
    html += `<a href="${escHtml(ds.url)}" target="_blank" rel="noopener" class="ds-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Datasheet${ds.name ? ' (' + escHtml(ds.name) + ')' : ''}
    </a>`;
  }
  html += `<a href="https://octopart.com/search?q=${encodeURIComponent(p.mpn || query)}" target="_blank" rel="noopener" class="ds-btn ds-btn-outline">Octopart â†—</a>`;
  html += `<a href="https://www.digikey.com/en/products/result?keywords=${encodeURIComponent(p.mpn || query)}" target="_blank" rel="noopener" class="ds-btn ds-btn-outline">DigiKey â†—</a>`;
  html += '</div></div>';
  return html;
}

// â”€â”€ TrustedParts Mode Search â”€â”€
async function trustedPartsSearch(query) {
  if (!tpCreds) {
    if (!isAdmin || !adminKey) throw new Error('Admin login required to use TrustedParts API');
    tpCreds = await loadEncrypted(STORAGE_KEYS.tpEncrypted);
    if (!tpCreds) throw new Error('TrustedParts credentials not configured. Open Settings to add them.');
  }
  const res = await fetch(TP_SEARCH_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ApiKey: tpCreds.apiKey,
      CompanyId: tpCreds.companyId,
      PartNumbers: [query],
    }),
  });
  if (!res.ok) {
    const text = await res.text().catch(() => '');
    throw new Error(`TrustedParts API error (${res.status})${text ? ': ' + text.slice(0, 200) : ''}`);
  }
  return res.json();
}

async function doTpSearch(query) {
  const resultsEl = document.getElementById('search-results');
  const browseEl = document.getElementById('browse-content');
  searching = true;
  btnSearch.disabled = true;

  resultsEl.innerHTML = `<div class="api-loading"><div class="spinner"></div><div>Searching TrustedParts for <strong style="color:var(--accent);font-family:monospace">${escHtml(query)}</strong>...</div></div>`;
  resultsEl.style.display = 'block';
  browseEl.style.display = 'none';

  try {
    const data = await trustedPartsSearch(query);
    renderTpResults(query, data);
  } catch (e) {
    resultsEl.innerHTML = `<div class="api-error">Search failed: ${escHtml(e.message)}<code>Check your TrustedParts credentials in Settings, or switch to Link Mode.</code></div>`;
  } finally {
    searching = false;
    btnSearch.disabled = false;
  }
}

function renderTpResults(query, data) {
  const resultsEl = document.getElementById('search-results');
  const isBookmarked = bookmarks.some(b => b.query.toLowerCase() === query.toLowerCase());

  // TrustedParts v2 returns an array of results per part number
  const products = Array.isArray(data) ? data : (data.Products || data.products || [data]);
  // Flatten: each result may have offers from multiple distributors
  let allOffers = [];
  for (const product of products) {
    const offers = product.Offers || product.offers || product.Results || product.results || [];
    if (Array.isArray(offers)) {
      allOffers = allOffers.concat(offers);
    }
  }

  let html = `<div class="api-results-header">
    <h3>TrustedParts: <span style="color:var(--accent);font-family:monospace">${escHtml(query)}</span>
      <button class="icon-btn${isBookmarked ? ' bookmarked' : ''}" onclick="toggleBookmark('${escAttr(query)}')" title="Bookmark" style="display:inline-flex;vertical-align:middle;margin-left:4px;width:24px;height:24px;font-size:13px">${isBookmarked ? 'â˜…' : 'â˜†'}</button>
    </h3>
    <span class="hits">${allOffers.length} offer${allOffers.length !== 1 ? 's' : ''} found</span>
  </div>`;

  if (allOffers.length === 0) {
    // Maybe the API returned data in a different structure - show raw info
    const hasAnyData = JSON.stringify(data).length > 10;
    if (hasAnyData && !Array.isArray(data)) {
      html += renderTpRawResult(query, data);
    } else {
      html += `<div class="list-empty">No distributor offers found for "${escHtml(query)}".<br>Try a different part number or switch to another search mode.</div>`;
    }
    // Fallback links
    html += '<div class="source-row" style="margin-top:16px">';
    for (const src of SOURCES) {
      html += `<a href="${src.url.replace('{q}', encodeURIComponent(query))}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
    }
    html += '</div>';
  } else {
    // Group offers by distributor
    const byDist = {};
    for (const offer of allOffers) {
      const dist = offer.DistributorName || offer.distributorName || offer.Distributor || offer.distributor || 'Unknown';
      if (!byDist[dist]) byDist[dist] = [];
      byDist[dist].push(offer);
    }

    for (const [dist, offers] of Object.entries(byDist)) {
      html += `<div class="part-card">
        <div class="part-card-head">
          <div class="part-card-info">
            <div class="part-card-mpn">${escHtml(dist)}</div>
            <div class="part-card-mfr">${offers.length} offer${offers.length !== 1 ? 's' : ''} for ${escHtml(query)}</div>
          </div>
        </div>`;

      html += '<div style="margin-top:8px">';
      for (const offer of offers.slice(0, 5)) {
        const mpn = offer.ManufacturerPartNumber || offer.Mpn || offer.mpn || query;
        const mfr = offer.ManufacturerName || offer.Manufacturer || offer.manufacturer || '';
        const stock = offer.QuantityAvailable || offer.Stock || offer.stock || offer.Quantity || '';
        const url = offer.BuyUrl || offer.Url || offer.url || offer.BuyLink || '';
        const price = offer.UnitPrice || offer.Price || offer.price || '';
        const currency = offer.Currency || offer.currency || 'USD';
        const moq = offer.MinimumOrderQuantity || offer.Moq || offer.moq || '';
        const pkg = offer.Packaging || offer.packaging || '';
        const desc = offer.Description || offer.description || '';

        html += `<div style="padding:8px 0;border-top:1px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
            <div>
              <span style="font-family:monospace;font-weight:600;color:var(--tx-1)">${escHtml(String(mpn))}</span>
              ${mfr ? `<span style="color:var(--tx-3);font-size:11px;margin-left:8px">${escHtml(String(mfr))}</span>` : ''}
              ${desc ? `<div style="color:var(--tx-3);font-size:11px;margin-top:2px">${escHtml(String(desc).slice(0, 100))}</div>` : ''}
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              ${stock ? `<span class="spec-tag"><b>Stock</b> ${escHtml(String(stock))}</span>` : ''}
              ${price ? `<span class="spec-tag"><b>Price</b> ${escHtml(String(price))} ${escHtml(currency)}</span>` : ''}
              ${moq ? `<span class="spec-tag"><b>MOQ</b> ${escHtml(String(moq))}</span>` : ''}
              ${pkg ? `<span class="spec-tag"><b>Pkg</b> ${escHtml(String(pkg))}</span>` : ''}
              ${url ? `<a href="${escHtml(String(url))}" target="_blank" rel="noopener" class="ds-btn" style="font-size:11px;padding:4px 10px">Buy â†—</a>` : ''}
            </div>
          </div>
        </div>`;
      }
      if (offers.length > 5) {
        html += `<div style="padding:6px 0;color:var(--tx-3);font-size:11px;text-align:center">+ ${offers.length - 5} more offers</div>`;
      }
      html += '</div></div>';
    }

    // Also show link sources at bottom
    html += '<div style="margin-top:16px"><div class="parts-title">Also search on</div><div class="source-row" style="justify-content:flex-start">';
    for (const src of SOURCES) {
      html += `<a href="${src.url.replace('{q}', encodeURIComponent(query))}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
    }
    html += '</div></div>';
  }

  resultsEl.innerHTML = html;
}

function renderTpRawResult(query, data) {
  // Render any structured data the API returns even if we don't fully recognize the schema
  let html = '<div class="part-card"><div class="part-card-head"><div class="part-card-info">';
  html += `<div class="part-card-mpn">${escHtml(query)}</div>`;
  html += '<div class="part-card-desc" style="margin-top:6px">TrustedParts returned data in an unexpected format. Showing raw results:</div>';
  html += '</div></div>';
  html += `<pre style="margin-top:10px;padding:10px;background:var(--bg-0);border-radius:6px;font-size:11px;color:var(--tx-3);overflow-x:auto;max-height:300px">${escHtml(JSON.stringify(data, null, 2))}</pre>`;
  html += '</div>';
  return html;
}

function clearSearchResults() {
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('browse-content').style.display = '';
}

// â”€â”€ Bookmarks â”€â”€
function toggleBookmark(query) {
  const idx = bookmarks.findIndex(b => b.query.toLowerCase() === query.toLowerCase());
  if (idx >= 0) bookmarks.splice(idx, 1);
  else bookmarks.unshift({ query, timestamp: Date.now() });
  saveBookmarks();
  if (document.getElementById('search-results').style.display !== 'none') {
    const input = document.getElementById('search-input').value.trim();
    if (input) {
      if (searchMode !== 'link') {
        // Just update the bookmark icon without re-fetching
        document.querySelectorAll('#search-results .icon-btn').forEach(btn => {
          if (btn.onclick?.toString().includes(query.replace(/'/g, "\\'"))) {
            const isBm = bookmarks.some(b => b.query.toLowerCase() === query.toLowerCase());
            btn.className = 'icon-btn' + (isBm ? ' bookmarked' : '');
            btn.innerHTML = isBm ? 'â˜…' : 'â˜†';
          }
        });
      } else {
        showLinkResults(input);
      }
    }
  }
  renderBookmarks();
}

// â”€â”€ Render â”€â”€
function renderPopular() {
  document.getElementById('popular-chips').innerHTML = POPULAR.map(p =>
    `<div class="part-chip" onclick="doSearch('${p}')">${p}</div>`
  ).join('');
}

function renderCategories() {
  document.getElementById('cat-grid').innerHTML = CATEGORIES.map((cat, i) =>
    `<div class="cat-card" onclick="showCategory(${i})">
      <div class="cat-icon">${cat.icon}</div>
      <h3>${cat.title}</h3>
      <p>${cat.desc}</p>
    </div>`
  ).join('');
}

function showCategory(idx) {
  const cat = CATEGORIES[idx];
  const el = document.getElementById('popular-chips');
  el.innerHTML = cat.parts.map(p =>
    `<div class="part-chip" onclick="doSearch('${p}')">${p}</div>`
  ).join('');
  el.previousElementSibling.innerHTML = cat.icon + ' ' + cat.title;
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderHistory() {
  const el = document.getElementById('history-list');
  if (searchHistory.length === 0) {
    el.innerHTML = '<div class="list-empty">No search history yet.<br>Your searches will appear here.</div>';
    return;
  }
  let html = searchHistory.map(h => {
    const ago = timeAgo(new Date(h.timestamp));
    const isBookmarked = bookmarks.some(b => b.query.toLowerCase() === h.query.toLowerCase());
    return `<div class="list-item">
      <div class="list-item-text" onclick="doSearch('${escAttr(h.query)}')" style="cursor:pointer">
        <div class="list-item-query">${escHtml(h.query)}</div>
        <div class="list-item-meta">${ago}</div>
      </div>
      <div class="list-item-actions">
        <button class="icon-btn${isBookmarked ? ' bookmarked' : ''}" onclick="toggleBookmark('${escAttr(h.query)}')" title="Bookmark">${isBookmarked ? 'â˜…' : 'â˜†'}</button>
        <button class="icon-btn danger" onclick="removeHistory('${escAttr(h.query)}')" title="Remove">âœ•</button>
      </div>
    </div>`;
  }).join('');
  html += '<button class="clear-btn" onclick="clearHistory()">Clear All History</button>';
  el.innerHTML = html;
}

function renderBookmarks() {
  const el = document.getElementById('bookmarks-list');
  if (bookmarks.length === 0) {
    el.innerHTML = '<div class="list-empty">No bookmarks yet.<br>Star a search to save it here.</div>';
    return;
  }
  el.innerHTML = bookmarks.map(b =>
    `<div class="list-item">
      <div class="list-item-text" onclick="doSearch('${escAttr(b.query)}')" style="cursor:pointer">
        <div class="list-item-query">${escHtml(b.query)}</div>
        <div class="list-item-meta">Saved ${timeAgo(new Date(b.timestamp))}</div>
      </div>
      <div class="list-item-actions">
        <button class="icon-btn danger" onclick="removeBookmark('${escAttr(b.query)}')" title="Remove">âœ•</button>
      </div>
    </div>`
  ).join('');
}

function removeHistory(query) {
  searchHistory = searchHistory.filter(h => h.query !== query);
  saveHistory();
  renderHistory();
}

function clearHistory() {
  searchHistory = [];
  saveHistory();
  renderHistory();
}

function removeBookmark(query) {
  bookmarks = bookmarks.filter(b => b.query !== query);
  saveBookmarks();
  renderBookmarks();
  if (document.getElementById('search-results').style.display !== 'none') {
    const input = document.getElementById('search-input').value.trim();
    if (input && searchMode === 'link') showLinkResults(input);
  }
}

// â”€â”€ Tabs â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + name));
  if (name === 'history') renderHistory();
  if (name === 'bookmarks') renderBookmarks();
  if (name === 'browse') {
    const q = document.getElementById('search-input').value.trim();
    if (!q) clearSearchResults();
  }
}

// â”€â”€ Helpers â”€â”€
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s) { return s.replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function timeAgo(date) {
  const s = Math.floor((Date.now() - date.getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  if (s < 604800) return Math.floor(s / 86400) + 'd ago';
  return date.toLocaleDateString();
}

// â”€â”€ Init â”€â”€
document.getElementById('btn-search').addEventListener('click', () => doSearch(document.getElementById('search-input').value));
document.getElementById('search-input').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(e.target.value); });
document.getElementById('search-input').addEventListener('input', e => { if (!e.target.value.trim()) clearSearchResults(); });
document.querySelectorAll('.tabs .tab-btn').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));

// Migrate old unencrypted credentials (remove them)
if (localStorage.getItem('ds-nexar-client-id')) {
  localStorage.removeItem('ds-nexar-client-id');
  localStorage.removeItem('ds-nexar-client-secret');
}

// Settings button starts locked (admin auth required)
btnSettings.classList.add('locked');

updateModeUI();
renderPopular();
renderCategories();
renderHistory();
renderBookmarks();
</script>
</body>
</html>
