<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Datasheet Search</title>
<style>
:root {
  --bg-0: #09090b;
  --bg-1: #18181b;
  --bg-2: #27272a;
  --bg-3: #3f3f46;
  --tx-1: #f4f4f5;
  --tx-2: #a1a1aa;
  --tx-3: #71717a;
  --accent: #f59e0b;
  --accent-h: #d97706;
  --accent-bg: rgba(245,158,11,.12);
  --danger: #ef4444;
  --success: #22c55e;
  --border: #27272a;
  --radius: 8px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-0);
  color: var(--tx-1);
  min-height: 100vh;
}

/* Header */
.header {
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  text-align: center;
}
.header h1 {
  font-size: 20px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.header p {
  font-size: 12px;
  color: var(--tx-3);
}

/* Mode toggle row */
.mode-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}
.mode-label {
  font-size: 12px;
  color: var(--tx-3);
  font-weight: 500;
  transition: color .15s;
}
.mode-label.active { color: var(--accent); }
.toggle {
  position: relative;
  width: 40px;
  height: 22px;
  flex-shrink: 0;
}
.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-track {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: var(--bg-3);
  border-radius: 11px;
  transition: background .2s;
}
.toggle-track::after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  left: 3px;
  top: 3px;
  background: var(--tx-2);
  border-radius: 50%;
  transition: transform .2s, background .2s;
}
.toggle input:checked + .toggle-track {
  background: var(--accent);
}
.toggle input:checked + .toggle-track::after {
  transform: translateX(18px);
  background: var(--bg-0);
}
.api-settings-btn {
  background: none;
  border: 1px solid var(--bg-3);
  border-radius: 6px;
  color: var(--tx-3);
  font-size: 14px;
  cursor: pointer;
  width: 28px;
  height: 28px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all .15s;
}
.api-settings-btn:hover { border-color: var(--accent); color: var(--accent); }
.api-settings-btn.configured { color: var(--success); border-color: var(--success); }

/* Search */
.search-wrap {
  max-width: 720px;
  margin: 24px auto 0;
  padding: 0 16px;
}
.search-box {
  display: flex;
  gap: 8px;
}
.search-box input {
  flex: 1;
  padding: 12px 16px;
  background: var(--bg-1);
  border: 1px solid var(--bg-3);
  border-radius: var(--radius);
  color: var(--tx-1);
  font-size: 15px;
  outline: none;
  transition: border-color .15s;
}
.search-box input::placeholder { color: var(--tx-3); }
.search-box input:focus { border-color: var(--accent); }
.search-box button {
  padding: 12px 24px;
  background: var(--accent);
  color: var(--bg-0);
  border: none;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
  transition: background .15s;
}
.search-box button:hover { background: var(--accent-h); }
.search-box button:disabled { opacity: .5; cursor: not-allowed; }
.search-hint {
  font-size: 11px;
  color: var(--tx-3);
  margin-top: 8px;
  text-align: center;
}

/* Tabs */
.tabs {
  max-width: 720px;
  margin: 20px auto 0;
  padding: 0 16px;
  display: flex;
  gap: 4px;
  border-bottom: 1px solid var(--border);
}
.tab-btn {
  padding: 8px 16px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--tx-3);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
}
.tab-btn:hover { color: var(--tx-2); }
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

/* Content */
.content {
  max-width: 720px;
  margin: 0 auto;
  padding: 16px;
}
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Quick search categories */
.cat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 10px;
}
.cat-card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  cursor: pointer;
  transition: all .15s;
}
.cat-card:hover { border-color: var(--accent); background: var(--accent-bg); }
.cat-card h3 {
  font-size: 13px;
  font-weight: 600;
  color: var(--tx-1);
  margin-bottom: 4px;
}
.cat-card p {
  font-size: 11px;
  color: var(--tx-3);
  line-height: 1.4;
}
.cat-card .cat-icon {
  font-size: 18px;
  margin-bottom: 6px;
}

/* Common parts */
.parts-section {
  margin-bottom: 20px;
}
.parts-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--tx-3);
  margin-bottom: 8px;
}
.parts-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.part-chip {
  padding: 5px 12px;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 12px;
  color: var(--tx-2);
  cursor: pointer;
  transition: all .12s;
  font-family: 'Courier New', monospace;
  font-weight: 500;
}
.part-chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }

/* History / Bookmarks list */
.list-empty {
  text-align: center;
  padding: 32px 16px;
  color: var(--tx-3);
  font-size: 13px;
}
.list-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 6px;
  transition: border-color .12s;
}
.list-item:hover { border-color: var(--bg-3); }
.list-item-text {
  flex: 1;
  min-width: 0;
}
.list-item-query {
  font-size: 14px;
  font-weight: 600;
  color: var(--tx-1);
  font-family: 'Courier New', monospace;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.list-item-meta {
  font-size: 11px;
  color: var(--tx-3);
  margin-top: 2px;
}
.list-item-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}
.icon-btn {
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-2);
  border: none;
  border-radius: 6px;
  color: var(--tx-3);
  cursor: pointer;
  font-size: 14px;
  transition: all .12s;
}
.icon-btn:hover { background: var(--bg-3); color: var(--tx-1); }
.icon-btn.bookmarked { color: var(--accent); }
.icon-btn.danger:hover { color: var(--danger); }
.clear-btn {
  display: block;
  margin: 12px auto 0;
  padding: 6px 16px;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--tx-3);
  font-size: 12px;
  cursor: pointer;
}
.clear-btn:hover { border-color: var(--danger); color: var(--danger); }

/* Results status (link mode) */
.search-status {
  text-align: center;
  padding: 20px;
  font-size: 13px;
  color: var(--tx-3);
}
.search-status a {
  color: var(--accent);
  text-decoration: none;
}
.search-status a:hover { text-decoration: underline; }

/* Source badges */
.source-row {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 12px;
  flex-wrap: wrap;
}
.source-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--tx-2);
  font-size: 13px;
  font-weight: 500;
  text-decoration: none;
  transition: all .15s;
}
.source-link:hover { border-color: var(--accent); color: var(--accent); }
.source-link .arrow { font-size: 11px; opacity: .6; }

/* â”€â”€ NEXAR API results â”€â”€ */
.api-results-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.api-results-header h3 {
  font-size: 14px;
  font-weight: 600;
  color: var(--tx-2);
}
.api-results-header .hits {
  font-size: 12px;
  color: var(--tx-3);
}
.api-loading {
  text-align: center;
  padding: 40px 16px;
  color: var(--tx-3);
}
.api-loading .spinner {
  display: inline-block;
  width: 24px;
  height: 24px;
  border: 3px solid var(--bg-3);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  margin-bottom: 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.api-error {
  text-align: center;
  padding: 24px 16px;
  color: var(--danger);
  font-size: 13px;
  background: rgba(239,68,68,.08);
  border: 1px solid rgba(239,68,68,.2);
  border-radius: var(--radius);
}
.api-error code {
  display: block;
  margin-top: 6px;
  font-size: 11px;
  color: var(--tx-3);
  word-break: break-all;
}

/* Part card */
.part-card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 10px;
  transition: border-color .15s;
}
.part-card:hover { border-color: var(--bg-3); }
.part-card-head {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 8px;
}
.part-card-info { flex: 1; min-width: 0; }
.part-card-mpn {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent);
  font-family: 'Courier New', monospace;
}
.part-card-mfr {
  font-size: 12px;
  color: var(--tx-3);
  margin-top: 2px;
}
.part-card-desc {
  font-size: 13px;
  color: var(--tx-2);
  margin-top: 6px;
  line-height: 1.4;
}
.part-card-img {
  width: 56px;
  height: 56px;
  border-radius: 6px;
  background: var(--bg-2);
  object-fit: contain;
  flex-shrink: 0;
}
.part-card-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}
.ds-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 6px 14px;
  background: var(--accent);
  color: var(--bg-0);
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: background .15s;
}
.ds-btn:hover { background: var(--accent-h); }
.ds-btn svg { width: 14px; height: 14px; }
.ds-btn-outline {
  background: transparent;
  color: var(--tx-2);
  border: 1px solid var(--bg-3);
}
.ds-btn-outline:hover { border-color: var(--accent); color: var(--accent); background: transparent; }
.part-specs {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.spec-tag {
  font-size: 11px;
  padding: 3px 8px;
  background: var(--bg-2);
  border-radius: 4px;
  color: var(--tx-3);
}
.spec-tag b { color: var(--tx-2); font-weight: 600; }
.part-card-cat {
  font-size: 11px;
  color: var(--tx-3);
  margin-top: 6px;
}

/* Modal */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-bg.active { display: flex; }
.modal {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 420px;
}
.modal h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--tx-1);
  margin-bottom: 4px;
}
.modal .modal-desc {
  font-size: 12px;
  color: var(--tx-3);
  margin-bottom: 16px;
  line-height: 1.5;
}
.modal label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--tx-2);
  margin-bottom: 4px;
  margin-top: 12px;
}
.modal label:first-of-type { margin-top: 0; }
.modal input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-2);
  border: 1px solid var(--bg-3);
  border-radius: 6px;
  color: var(--tx-1);
  font-size: 13px;
  font-family: 'Courier New', monospace;
  outline: none;
}
.modal input:focus { border-color: var(--accent); }
.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}
.modal-actions button {
  padding: 8px 18px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
}
.modal-actions .btn-save { background: var(--accent); color: var(--bg-0); }
.modal-actions .btn-save:hover { background: var(--accent-h); }
.modal-actions .btn-cancel { background: var(--bg-2); color: var(--tx-2); }
.modal-actions .btn-cancel:hover { background: var(--bg-3); color: var(--tx-1); }
.modal-actions .btn-clear { background: none; color: var(--danger); border: 1px solid var(--danger); }
.modal-actions .btn-clear:hover { background: var(--danger); color: var(--tx-1); }
.modal-status {
  font-size: 11px;
  margin-top: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  display: none;
}
.modal-status.ok { display: block; background: rgba(34,197,94,.1); color: var(--success); border: 1px solid rgba(34,197,94,.2); }
.modal-status.err { display: block; background: rgba(239,68,68,.1); color: var(--danger); border: 1px solid rgba(239,68,68,.2); }

@media (max-width: 480px) {
  .cat-grid { grid-template-columns: 1fr 1fr; }
  .search-box { flex-direction: column; }
  .search-box button { width: 100%; }
  .header { padding: 12px 16px; }
}
</style>
</head>
<body>

<div class="header">
  <h1>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    Datasheet Search
  </h1>
  <p>Search electronic component datasheets across multiple sources</p>
  <div class="mode-row">
    <span class="mode-label" id="label-link">Link Mode</span>
    <label class="toggle">
      <input type="checkbox" id="mode-toggle">
      <span class="toggle-track"></span>
    </label>
    <span class="mode-label" id="label-api">NEXAR API</span>
    <button class="api-settings-btn" id="btn-api-settings" title="API Settings">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>
</div>

<div class="search-wrap">
  <div class="search-box">
    <input type="text" id="search-input" placeholder="Enter part number (e.g. LM7805, ATmega328P, NE555)..." autofocus>
    <button id="btn-search">Search</button>
  </div>
  <div class="search-hint" id="search-hint">Press Enter to search &bull; Results open on datasheet provider sites</div>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="browse">Browse</button>
  <button class="tab-btn" data-tab="history">History</button>
  <button class="tab-btn" data-tab="bookmarks">Bookmarks</button>
</div>

<div class="content">

  <!-- Browse tab -->
  <div class="tab-panel active" id="tab-browse">

    <div id="search-results" style="display:none"></div>

    <div id="browse-content">
      <div class="parts-section">
        <div class="parts-title">Popular Components</div>
        <div class="parts-chips" id="popular-chips"></div>
      </div>

      <div class="parts-section">
        <div class="parts-title">Quick Categories</div>
        <div class="cat-grid" id="cat-grid"></div>
      </div>
    </div>
  </div>

  <!-- History tab -->
  <div class="tab-panel" id="tab-history">
    <div id="history-list"></div>
  </div>

  <!-- Bookmarks tab -->
  <div class="tab-panel" id="tab-bookmarks">
    <div id="bookmarks-list"></div>
  </div>

</div>

<!-- API Settings Modal -->
<div class="modal-bg" id="settings-modal">
  <div class="modal">
    <h3>NEXAR API Settings</h3>
    <p class="modal-desc">
      Enter your NEXAR API credentials to search parts directly.
      Get free API keys at <a href="https://nexar.com/api" target="_blank" rel="noopener" style="color:var(--accent)">nexar.com/api</a>.
      Credentials are stored locally in your browser.
    </p>
    <label for="cfg-client-id">Client ID</label>
    <input type="text" id="cfg-client-id" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" autocomplete="off">
    <label for="cfg-client-secret">Client Secret</label>
    <input type="password" id="cfg-client-secret" placeholder="Client secret" autocomplete="off">
    <div class="modal-status" id="settings-status"></div>
    <div class="modal-actions">
      <button class="btn-clear" id="btn-cfg-clear">Clear</button>
      <button class="btn-cancel" id="btn-cfg-cancel">Cancel</button>
      <button class="btn-save" id="btn-cfg-save">Save &amp; Test</button>
    </div>
  </div>
</div>

<script>
// ===================================================================
// DATASHEET SEARCH APP â€” Link Mode + NEXAR API Mode
// ===================================================================

const STORAGE_KEYS = {
  history: 'ds-search-history',
  bookmarks: 'ds-search-bookmarks',
  mode: 'ds-search-mode',
  nexarId: 'ds-nexar-client-id',
  nexarSecret: 'ds-nexar-client-secret',
};

// â”€â”€ NEXAR API Config â”€â”€
const NEXAR_TOKEN_URL = 'https://identity.nexar.com/connect/token';
const NEXAR_GQL_URL   = 'https://api.nexar.com/graphql';

const NEXAR_QUERY = `
query SearchParts($q: String!) {
  supSearchMpn(q: $q, limit: 10) {
    hits
    results {
      part {
        mpn
        manufacturer { name }
        shortDescription
        category { name path }
        bestDatasheet { url name }
        specs {
          attribute { name shortname }
          displayValue
        }
        images { url }
      }
    }
  }
}`;

// â”€â”€ Link-mode Sources â”€â”€
const SOURCES = [
  { name: 'AllDatasheet',    url: 'https://www.alldatasheet.com/view.jsp?Searchword={q}',   icon: 'ðŸ“„' },
  { name: 'Datasheet Archive', url: 'https://www.datasheetarchive.com/search?q={q}',          icon: 'ðŸ—„ï¸' },
  { name: 'Octopart',        url: 'https://octopart.com/search?q={q}',                      icon: 'ðŸ”' },
  { name: 'DigiKey',         url: 'https://www.digikey.com/en/products/result?keywords={q}', icon: 'ðŸ›’' },
  { name: 'Mouser',          url: 'https://www.mouser.com/c/?q={q}',                        icon: 'ðŸ›’' },
  { name: 'LCSC',            url: 'https://www.lcsc.com/search?q={q}',                      icon: 'ðŸ›’' },
];

const POPULAR = [
  'NE555','LM7805','LM317','ATmega328P','ESP32','STM32F103',
  'LM358','TL072','LM393','IRF540N','TIP120','2N2222',
  'AMS1117-3.3','MCP2515','MAX232','74HC595','CD4017','LM386',
  'W25Q128','ADS1115','BME280','MPU6050','INA219','TPS63020',
];

const CATEGORIES = [
  { icon: 'âš¡', title: 'Voltage Regulators', desc: 'Linear & switching regulators', parts: ['LM7805','LM317','AMS1117','TPS63020','LM2596','AP2112'] },
  { icon: 'ðŸ”Š', title: 'Op-Amps & Audio', desc: 'Operational amplifiers, audio ICs', parts: ['LM358','TL072','NE5532','LM386','TDA2030','LM4871'] },
  { icon: 'ðŸ§ ', title: 'Microcontrollers', desc: 'MCUs and development chips', parts: ['ATmega328P','ESP32','STM32F103','PIC16F877','RP2040','ATTINY85'] },
  { icon: 'ðŸ“¡', title: 'Communication', desc: 'UART, SPI, I2C, CAN, RF', parts: ['MAX232','MCP2515','MCP2551','NRF24L01','CC1101','SX1276'] },
  { icon: 'ðŸ’¡', title: 'LED Drivers', desc: 'Constant current & PWM drivers', parts: ['WS2812B','TLC5940','PCA9685','AL8805','PT4115','CAT4101'] },
  { icon: 'ðŸ”Œ', title: 'Transistors & MOSFETs', desc: 'BJTs, MOSFETs, IGBTs', parts: ['2N2222','BC547','IRF540N','IRFZ44N','TIP120','IRF3205'] },
  { icon: 'ðŸ“', title: 'Sensors', desc: 'Temperature, motion, pressure', parts: ['BME280','MPU6050','DHT22','DS18B20','BMP280','ADXL345'] },
  { icon: 'ðŸ’¾', title: 'Memory & Storage', desc: 'EEPROM, Flash, SRAM', parts: ['W25Q128','AT24C256','23LC1024','IS62WV1288','SST39SF040','M25P16'] },
  { icon: 'â±ï¸', title: 'Timers & Logic', desc: '555 timers, logic gates, counters', parts: ['NE555','74HC595','CD4017','74HC245','SN74LVC1G14','CD4051'] },
  { icon: 'ðŸ”‹', title: 'Power Management', desc: 'Battery chargers, converters', parts: ['TP4056','BQ24195','TPS54331','INA219','MAX17048','LTC3780'] },
];

// â”€â”€ State â”€â”€
let searchHistory = JSON.parse(localStorage.getItem(STORAGE_KEYS.history) || '[]');
let bookmarks = JSON.parse(localStorage.getItem(STORAGE_KEYS.bookmarks) || '[]');
let useApi = localStorage.getItem(STORAGE_KEYS.mode) === 'api';
let nexarToken = null;
let nexarTokenExp = 0;
let searching = false;

function saveHistory() { localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(searchHistory)); }
function saveBookmarks() { localStorage.setItem(STORAGE_KEYS.bookmarks, JSON.stringify(bookmarks)); }

// â”€â”€ DOM refs â”€â”€
const modeToggle  = document.getElementById('mode-toggle');
const labelLink   = document.getElementById('label-link');
const labelApi    = document.getElementById('label-api');
const searchHint  = document.getElementById('search-hint');
const btnSettings = document.getElementById('btn-api-settings');
const settingsModal = document.getElementById('settings-modal');
const btnSearch   = document.getElementById('btn-search');

// â”€â”€ Mode Toggle â”€â”€
function updateModeUI() {
  modeToggle.checked = useApi;
  labelLink.classList.toggle('active', !useApi);
  labelApi.classList.toggle('active', useApi);
  searchHint.textContent = useApi
    ? 'Press Enter to search via NEXAR API'
    : 'Press Enter to search \u2022 Results open on datasheet provider sites';
  const hasKeys = !!(localStorage.getItem(STORAGE_KEYS.nexarId));
  btnSettings.classList.toggle('configured', hasKeys);
}

modeToggle.addEventListener('change', () => {
  useApi = modeToggle.checked;
  localStorage.setItem(STORAGE_KEYS.mode, useApi ? 'api' : 'link');
  updateModeUI();
  // If switching to API and no credentials, open settings
  if (useApi && !localStorage.getItem(STORAGE_KEYS.nexarId)) {
    openSettings();
  }
});

// â”€â”€ Settings Modal â”€â”€
function openSettings() {
  document.getElementById('cfg-client-id').value = localStorage.getItem(STORAGE_KEYS.nexarId) || '';
  document.getElementById('cfg-client-secret').value = localStorage.getItem(STORAGE_KEYS.nexarSecret) || '';
  const st = document.getElementById('settings-status');
  st.className = 'modal-status';
  st.style.display = 'none';
  settingsModal.classList.add('active');
}

btnSettings.addEventListener('click', openSettings);
document.getElementById('btn-cfg-cancel').addEventListener('click', () => settingsModal.classList.remove('active'));
document.getElementById('btn-cfg-clear').addEventListener('click', () => {
  localStorage.removeItem(STORAGE_KEYS.nexarId);
  localStorage.removeItem(STORAGE_KEYS.nexarSecret);
  nexarToken = null;
  nexarTokenExp = 0;
  document.getElementById('cfg-client-id').value = '';
  document.getElementById('cfg-client-secret').value = '';
  const st = document.getElementById('settings-status');
  st.textContent = 'Credentials cleared.';
  st.className = 'modal-status ok';
  updateModeUI();
});

document.getElementById('btn-cfg-save').addEventListener('click', async () => {
  const id = document.getElementById('cfg-client-id').value.trim();
  const secret = document.getElementById('cfg-client-secret').value.trim();
  const st = document.getElementById('settings-status');
  if (!id || !secret) {
    st.textContent = 'Both Client ID and Client Secret are required.';
    st.className = 'modal-status err';
    return;
  }
  st.textContent = 'Testing connection...';
  st.className = 'modal-status ok';

  try {
    const token = await fetchNexarToken(id, secret);
    if (token) {
      localStorage.setItem(STORAGE_KEYS.nexarId, id);
      localStorage.setItem(STORAGE_KEYS.nexarSecret, secret);
      st.textContent = 'Connected successfully! Token valid for 24h.';
      st.className = 'modal-status ok';
      updateModeUI();
      setTimeout(() => settingsModal.classList.remove('active'), 1200);
    }
  } catch (e) {
    st.textContent = 'Connection failed: ' + e.message;
    st.className = 'modal-status err';
  }
});

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && settingsModal.classList.contains('active')) {
    settingsModal.classList.remove('active');
  }
});

// â”€â”€ NEXAR API â”€â”€
async function fetchNexarToken(clientId, clientSecret) {
  const body = new URLSearchParams({
    grant_type: 'client_credentials',
    client_id: clientId,
    client_secret: clientSecret,
  });
  const res = await fetch(NEXAR_TOKEN_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body,
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`Token request failed (${res.status})`);
  }
  const data = await res.json();
  nexarToken = data.access_token;
  nexarTokenExp = Date.now() + (data.expires_in - 60) * 1000; // 1min buffer
  return nexarToken;
}

async function getToken() {
  if (nexarToken && Date.now() < nexarTokenExp) return nexarToken;
  const id = localStorage.getItem(STORAGE_KEYS.nexarId);
  const secret = localStorage.getItem(STORAGE_KEYS.nexarSecret);
  if (!id || !secret) throw new Error('NEXAR API credentials not configured');
  return fetchNexarToken(id, secret);
}

async function nexarSearch(query) {
  const token = await getToken();
  const res = await fetch(NEXAR_GQL_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token,
    },
    body: JSON.stringify({ query: NEXAR_QUERY, variables: { q: query } }),
  });
  if (!res.ok) {
    throw new Error(`API request failed (${res.status})`);
  }
  const data = await res.json();
  if (data.errors) {
    throw new Error(data.errors.map(e => e.message).join('; '));
  }
  return data.data.supSearchMpn;
}

// â”€â”€ Search Dispatcher â”€â”€
async function doSearch(query) {
  query = query.trim();
  if (!query || searching) return;

  document.getElementById('search-input').value = query;

  // Add to history
  searchHistory = searchHistory.filter(h => h.query.toLowerCase() !== query.toLowerCase());
  searchHistory.unshift({ query, timestamp: Date.now() });
  if (searchHistory.length > 50) searchHistory.length = 50;
  saveHistory();

  switchTab('browse');

  if (useApi) {
    await doApiSearch(query);
  } else {
    doLinkSearch(query);
  }
}

// â”€â”€ Link Mode Search â”€â”€
function doLinkSearch(query) {
  showLinkResults(query);
  window.open(SOURCES[0].url.replace('{q}', encodeURIComponent(query)), '_blank');
}

function showLinkResults(query) {
  const resultsEl = document.getElementById('search-results');
  const browseEl = document.getElementById('browse-content');
  const isBookmarked = bookmarks.some(b => b.query.toLowerCase() === query.toLowerCase());

  let html = `<div class="search-status">
    <p>Searching for <strong style="color:var(--accent);font-family:'Courier New',monospace">${escHtml(query)}</strong></p>
    <p style="margin-top:4px">AllDatasheet opened in a new tab.
      <button class="icon-btn${isBookmarked ? ' bookmarked' : ''}" onclick="toggleBookmark('${escAttr(query)}')" title="${isBookmarked ? 'Remove bookmark' : 'Bookmark this search'}" style="display:inline-flex;vertical-align:middle;margin-left:4px">${isBookmarked ? 'â˜…' : 'â˜†'}</button>
    </p>
  </div>`;
  html += '<div class="source-row">';
  for (const src of SOURCES) {
    const url = src.url.replace('{q}', encodeURIComponent(query));
    html += `<a href="${url}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
  }
  html += '</div>';

  resultsEl.innerHTML = html;
  resultsEl.style.display = 'block';
  browseEl.style.display = 'none';
}

// â”€â”€ API Mode Search â”€â”€
async function doApiSearch(query) {
  const resultsEl = document.getElementById('search-results');
  const browseEl = document.getElementById('browse-content');
  searching = true;
  btnSearch.disabled = true;

  resultsEl.innerHTML = `<div class="api-loading"><div class="spinner"></div><div>Searching NEXAR for <strong style="color:var(--accent);font-family:'Courier New',monospace">${escHtml(query)}</strong>...</div></div>`;
  resultsEl.style.display = 'block';
  browseEl.style.display = 'none';

  try {
    const data = await nexarSearch(query);
    renderApiResults(query, data);
  } catch (e) {
    resultsEl.innerHTML = `<div class="api-error">Search failed: ${escHtml(e.message)}<code>Check your API credentials in Settings, or switch to Link Mode.</code></div>`;
  } finally {
    searching = false;
    btnSearch.disabled = false;
  }
}

function renderApiResults(query, data) {
  const resultsEl = document.getElementById('search-results');
  const results = data.results || [];
  const isBookmarked = bookmarks.some(b => b.query.toLowerCase() === query.toLowerCase());

  let html = `<div class="api-results-header">
    <h3>Results for <span style="color:var(--accent);font-family:'Courier New',monospace">${escHtml(query)}</span>
      <button class="icon-btn${isBookmarked ? ' bookmarked' : ''}" onclick="toggleBookmark('${escAttr(query)}')" title="Bookmark" style="display:inline-flex;vertical-align:middle;margin-left:4px;width:24px;height:24px;font-size:13px">${isBookmarked ? 'â˜…' : 'â˜†'}</button>
    </h3>
    <span class="hits">${data.hits || 0} total hits</span>
  </div>`;

  if (results.length === 0) {
    html += `<div class="list-empty">No parts found for "${escHtml(query)}".<br>Try a different part number or switch to Link Mode.</div>`;
    // Show link fallback
    html += '<div class="source-row" style="margin-top:16px">';
    for (const src of SOURCES) {
      html += `<a href="${src.url.replace('{q}', encodeURIComponent(query))}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
    }
    html += '</div>';
  } else {
    for (const r of results) {
      const p = r.part;
      html += renderPartCard(p, query);
    }
    // Also show link sources at bottom
    html += '<div style="margin-top:16px"><div class="parts-title">Also search on</div><div class="source-row" style="justify-content:flex-start">';
    for (const src of SOURCES) {
      html += `<a href="${src.url.replace('{q}', encodeURIComponent(query))}" target="_blank" rel="noopener" class="source-link">${src.icon} ${src.name} <span class="arrow">â†—</span></a>`;
    }
    html += '</div></div>';
  }

  resultsEl.innerHTML = html;
}

function renderPartCard(p, query) {
  const mfr = p.manufacturer?.name || 'Unknown';
  const desc = p.shortDescription || '';
  const ds = p.bestDatasheet;
  const img = p.images?.[0]?.url;
  const cat = p.category?.name || '';
  const catPath = p.category?.path || '';
  const specs = (p.specs || []).slice(0, 8);

  let html = `<div class="part-card">
    <div class="part-card-head">
      <div class="part-card-info">
        <div class="part-card-mpn">${escHtml(p.mpn || '')}</div>
        <div class="part-card-mfr">${escHtml(mfr)}</div>
        ${desc ? `<div class="part-card-desc">${escHtml(desc)}</div>` : ''}
        ${cat ? `<div class="part-card-cat">${escHtml(catPath || cat)}</div>` : ''}
      </div>
      ${img ? `<img class="part-card-img" src="${escHtml(img)}" alt="${escHtml(p.mpn)}" onerror="this.style.display='none'">` : ''}
    </div>`;

  if (specs.length) {
    html += '<div class="part-specs">';
    for (const s of specs) {
      const name = s.attribute?.shortname || s.attribute?.name || '';
      html += `<span class="spec-tag"><b>${escHtml(name)}</b> ${escHtml(s.displayValue || '')}</span>`;
    }
    html += '</div>';
  }

  html += '<div class="part-card-actions">';
  if (ds?.url) {
    html += `<a href="${escHtml(ds.url)}" target="_blank" rel="noopener" class="ds-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Datasheet${ds.name ? ' (' + escHtml(ds.name) + ')' : ''}
    </a>`;
  }
  html += `<a href="https://octopart.com/search?q=${encodeURIComponent(p.mpn || query)}" target="_blank" rel="noopener" class="ds-btn ds-btn-outline">Octopart â†—</a>`;
  html += `<a href="https://www.digikey.com/en/products/result?keywords=${encodeURIComponent(p.mpn || query)}" target="_blank" rel="noopener" class="ds-btn ds-btn-outline">DigiKey â†—</a>`;
  html += '</div></div>';
  return html;
}

function clearSearchResults() {
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('browse-content').style.display = '';
}

// â”€â”€ Bookmarks â”€â”€
function toggleBookmark(query) {
  const idx = bookmarks.findIndex(b => b.query.toLowerCase() === query.toLowerCase());
  if (idx >= 0) bookmarks.splice(idx, 1);
  else bookmarks.unshift({ query, timestamp: Date.now() });
  saveBookmarks();
  if (document.getElementById('search-results').style.display !== 'none') {
    const input = document.getElementById('search-input').value.trim();
    if (input) {
      if (useApi) {
        // Just update the bookmark icon without re-fetching
        document.querySelectorAll('#search-results .icon-btn').forEach(btn => {
          if (btn.onclick?.toString().includes(query.replace(/'/g, "\\'"))) {
            const isBm = bookmarks.some(b => b.query.toLowerCase() === query.toLowerCase());
            btn.className = 'icon-btn' + (isBm ? ' bookmarked' : '');
            btn.innerHTML = isBm ? 'â˜…' : 'â˜†';
          }
        });
      } else {
        showLinkResults(input);
      }
    }
  }
  renderBookmarks();
}

// â”€â”€ Render â”€â”€
function renderPopular() {
  document.getElementById('popular-chips').innerHTML = POPULAR.map(p =>
    `<div class="part-chip" onclick="doSearch('${p}')">${p}</div>`
  ).join('');
}

function renderCategories() {
  document.getElementById('cat-grid').innerHTML = CATEGORIES.map((cat, i) =>
    `<div class="cat-card" onclick="showCategory(${i})">
      <div class="cat-icon">${cat.icon}</div>
      <h3>${cat.title}</h3>
      <p>${cat.desc}</p>
    </div>`
  ).join('');
}

function showCategory(idx) {
  const cat = CATEGORIES[idx];
  const el = document.getElementById('popular-chips');
  el.innerHTML = cat.parts.map(p =>
    `<div class="part-chip" onclick="doSearch('${p}')">${p}</div>`
  ).join('');
  el.previousElementSibling.innerHTML = cat.icon + ' ' + cat.title;
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderHistory() {
  const el = document.getElementById('history-list');
  if (searchHistory.length === 0) {
    el.innerHTML = '<div class="list-empty">No search history yet.<br>Your searches will appear here.</div>';
    return;
  }
  let html = searchHistory.map(h => {
    const ago = timeAgo(new Date(h.timestamp));
    const isBookmarked = bookmarks.some(b => b.query.toLowerCase() === h.query.toLowerCase());
    return `<div class="list-item">
      <div class="list-item-text" onclick="doSearch('${escAttr(h.query)}')" style="cursor:pointer">
        <div class="list-item-query">${escHtml(h.query)}</div>
        <div class="list-item-meta">${ago}</div>
      </div>
      <div class="list-item-actions">
        <button class="icon-btn${isBookmarked ? ' bookmarked' : ''}" onclick="toggleBookmark('${escAttr(h.query)}')" title="Bookmark">${isBookmarked ? 'â˜…' : 'â˜†'}</button>
        <button class="icon-btn danger" onclick="removeHistory('${escAttr(h.query)}')" title="Remove">âœ•</button>
      </div>
    </div>`;
  }).join('');
  html += '<button class="clear-btn" onclick="clearHistory()">Clear All History</button>';
  el.innerHTML = html;
}

function renderBookmarks() {
  const el = document.getElementById('bookmarks-list');
  if (bookmarks.length === 0) {
    el.innerHTML = '<div class="list-empty">No bookmarks yet.<br>Star a search to save it here.</div>';
    return;
  }
  el.innerHTML = bookmarks.map(b =>
    `<div class="list-item">
      <div class="list-item-text" onclick="doSearch('${escAttr(b.query)}')" style="cursor:pointer">
        <div class="list-item-query">${escHtml(b.query)}</div>
        <div class="list-item-meta">Saved ${timeAgo(new Date(b.timestamp))}</div>
      </div>
      <div class="list-item-actions">
        <button class="icon-btn danger" onclick="removeBookmark('${escAttr(b.query)}')" title="Remove">âœ•</button>
      </div>
    </div>`
  ).join('');
}

function removeHistory(query) {
  searchHistory = searchHistory.filter(h => h.query !== query);
  saveHistory();
  renderHistory();
}

function clearHistory() {
  searchHistory = [];
  saveHistory();
  renderHistory();
}

function removeBookmark(query) {
  bookmarks = bookmarks.filter(b => b.query !== query);
  saveBookmarks();
  renderBookmarks();
  if (document.getElementById('search-results').style.display !== 'none') {
    const input = document.getElementById('search-input').value.trim();
    if (input && !useApi) showLinkResults(input);
  }
}

// â”€â”€ Tabs â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + name));
  if (name === 'history') renderHistory();
  if (name === 'bookmarks') renderBookmarks();
  if (name === 'browse') {
    const q = document.getElementById('search-input').value.trim();
    if (!q) clearSearchResults();
  }
}

// â”€â”€ Helpers â”€â”€
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s) { return s.replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function timeAgo(date) {
  const s = Math.floor((Date.now() - date.getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  if (s < 604800) return Math.floor(s / 86400) + 'd ago';
  return date.toLocaleDateString();
}

// â”€â”€ Init â”€â”€
document.getElementById('btn-search').addEventListener('click', () => doSearch(document.getElementById('search-input').value));
document.getElementById('search-input').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(e.target.value); });
document.getElementById('search-input').addEventListener('input', e => { if (!e.target.value.trim()) clearSearchResults(); });
document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => switchTab(b.dataset.tab)));

updateModeUI();
renderPopular();
renderCategories();
renderHistory();
renderBookmarks();
</script>
</body>
</html>
