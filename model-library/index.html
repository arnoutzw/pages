<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Model Library</title>
<style>
:root {
  --bg-0: #09090b;
  --bg-1: #18181b;
  --bg-2: #27272a;
  --bg-3: #3f3f46;
  --tx-1: #f4f4f5;
  --tx-2: #a1a1aa;
  --tx-3: #71717a;
  --accent: #f59e0b;
  --accent-h: #d97706;
  --accent-bg: rgba(245,158,11,.12);
  --danger: #ef4444;
  --success: #22c55e;
  --border: #27272a;
  --radius: 8px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-0);
  color: var(--tx-1);
  min-height: 100vh;
  overflow: hidden;
}

/* ── Header ── */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  height: 56px;
  flex-shrink: 0;
}
.header h1 {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}
.header h1 svg { width: 20px; height: 20px; }
.header-actions { display: flex; gap: 8px; align-items: center; }

/* ── Buttons ── */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
}
.btn svg { width: 15px; height: 15px; }
.btn-primary { background: var(--accent); color: var(--bg-0); }
.btn-primary:hover { background: var(--accent-h); }
.btn-secondary { background: var(--bg-2); color: var(--tx-2); border: 1px solid var(--bg-3); }
.btn-secondary:hover { background: var(--bg-3); color: var(--tx-1); }
.btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
.btn-danger:hover { background: var(--danger); color: var(--tx-1); }
.btn-icon {
  width: 34px; height: 34px; padding: 0;
  display: inline-flex; align-items: center; justify-content: center;
  background: var(--bg-2); color: var(--tx-2); border: 1px solid var(--bg-3);
  border-radius: 6px; cursor: pointer; transition: all .15s;
}
.btn-icon:hover { background: var(--bg-3); color: var(--tx-1); }
.btn-icon svg { width: 16px; height: 16px; }

/* ── Layout ── */
.app { display: flex; flex-direction: column; height: 100vh; }
.content { flex: 1; overflow: hidden; position: relative; }

/* ── Library Grid ── */
.library {
  padding: 20px;
  overflow-y: auto;
  height: 100%;
}
.library-info {
  font-size: 12px;
  color: var(--tx-3);
  margin-bottom: 16px;
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}
.card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  cursor: pointer;
  transition: border-color .15s, transform .1s;
}
.card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}
.card-thumb {
  width: 100%;
  aspect-ratio: 4/3;
  background: var(--bg-0);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.card-thumb canvas {
  width: 100%;
  height: 100%;
}
.card-thumb .placeholder-icon {
  color: var(--bg-3);
}
.card-thumb .placeholder-icon svg { width: 48px; height: 48px; }
.card-body {
  padding: 10px 12px;
  border-top: 1px solid var(--border);
}
.card-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--tx-1);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 4px;
}
.card-ext {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--accent);
  font-weight: 600;
  background: var(--accent-bg);
  padding: 1px 6px;
  border-radius: 3px;
}
.card-size {
  font-size: 11px;
  color: var(--tx-3);
}
.card-actions {
  display: flex;
  gap: 4px;
  padding: 0 12px 10px;
}
.card-actions .btn-icon { width: 28px; height: 28px; }
.card-actions .btn-icon svg { width: 13px; height: 13px; }

/* ── Empty State ── */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 60vh;
  color: var(--tx-3);
  text-align: center;
}
.empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; color: var(--bg-3); }
.empty-state h2 { font-size: 18px; color: var(--tx-2); margin-bottom: 8px; }
.empty-state p { font-size: 13px; max-width: 360px; line-height: 1.5; margin-bottom: 20px; }

/* ── Viewer ── */
.viewer {
  position: absolute;
  inset: 0;
  background: var(--bg-0);
  display: none;
  flex-direction: column;
}
.viewer.active { display: flex; }
.viewer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  z-index: 2;
}
.viewer-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--tx-1);
  display: flex;
  align-items: center;
  gap: 8px;
}
.viewer-title .badge {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--accent);
  font-weight: 600;
  background: var(--accent-bg);
  padding: 1px 6px;
  border-radius: 3px;
}
.viewer-actions { display: flex; gap: 6px; }
.viewer-canvas {
  flex: 1;
  position: relative;
  overflow: hidden;
}
.viewer-canvas canvas { display: block; }
.viewer-info {
  padding: 6px 16px;
  background: var(--bg-1);
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--tx-3);
  z-index: 2;
}

/* ── Drag overlay ── */
.drop-overlay {
  position: fixed;
  inset: 0;
  background: rgba(9, 9, 11, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  pointer-events: none;
}
.drop-overlay.active { display: flex; }
.drop-box {
  border: 2px dashed var(--accent);
  border-radius: 16px;
  padding: 48px 64px;
  text-align: center;
  color: var(--accent);
}
.drop-box svg { width: 48px; height: 48px; margin-bottom: 12px; }
.drop-box p { font-size: 15px; font-weight: 600; }
.drop-box span { font-size: 12px; color: var(--tx-3); display: block; margin-top: 4px; }

/* ── Modal ── */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-bg.active { display: flex; }
.modal {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 380px;
}
.modal h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--tx-1);
  margin-bottom: 16px;
}
.modal input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-2);
  border: 1px solid var(--bg-3);
  border-radius: 6px;
  color: var(--tx-1);
  font-size: 14px;
  outline: none;
  margin-bottom: 16px;
}
.modal input:focus { border-color: var(--accent); }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

/* ── Loading ── */
.loading-spinner {
  border: 3px solid var(--bg-3);
  border-top-color: var(--accent);
  border-radius: 50%;
  width: 36px;
  height: 36px;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(9,9,11,.7);
  z-index: 5;
}

/* ── Responsive ── */
@media (max-width: 600px) {
  .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
  .header { padding: 10px 14px; }
  .library { padding: 14px; }
}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <h1>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
      3D Model Library
    </h1>
    <div class="header-actions">
      <span id="model-count" class="library-info" style="margin:0"></span>
      <button class="btn btn-primary" id="btn-upload" title="Upload model">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload
      </button>
    </div>
  </div>

  <div class="content">
    <!-- Library Grid -->
    <div class="library" id="library-view">
      <div class="grid" id="model-grid"></div>
      <div class="empty-state" id="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
        <h2>No models yet</h2>
        <p>Upload STL, 3MF, AMF, or G-code files to build your library. Drag and drop or click Upload.</p>
        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Upload your first model
        </button>
      </div>
    </div>

    <!-- 3D Viewer -->
    <div class="viewer" id="viewer-panel">
      <div class="viewer-header">
        <div class="viewer-title">
          <span id="viewer-name">Model</span>
          <span class="badge" id="viewer-ext">STL</span>
        </div>
        <div class="viewer-actions">
          <button class="btn-icon" id="btn-viewer-rename" title="Rename">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
          <button class="btn-icon" id="btn-viewer-delete" title="Delete">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </button>
          <button class="btn btn-secondary" id="btn-viewer-close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            Close
          </button>
        </div>
      </div>
      <div class="viewer-canvas" id="viewer-canvas">
        <div class="loading-overlay" id="viewer-loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
      <div class="viewer-info" id="viewer-info"></div>
    </div>
  </div>
</div>

<!-- Drag & Drop overlay -->
<div class="drop-overlay" id="drop-overlay">
  <div class="drop-box">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    <p>Drop model files here</p>
    <span>STL, 3MF, AMF, G-code</span>
  </div>
</div>

<!-- Rename Modal -->
<div class="modal-bg" id="rename-modal">
  <div class="modal">
    <h3>Rename Model</h3>
    <input type="text" id="rename-input" placeholder="Model name" autocomplete="off">
    <div class="modal-actions">
      <button class="btn btn-secondary" id="rename-cancel">Cancel</button>
      <button class="btn btn-primary" id="rename-save">Save</button>
    </div>
  </div>
</div>

<!-- Hidden file input -->
<input type="file" id="file-input" multiple accept=".stl,.3mf,.amf,.gcode,.obj" style="display:none">

<!-- Three.js via importmap -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { ThreeMFLoader } from 'three/addons/loaders/3MFLoader.js';
import { AMFLoader } from 'three/addons/loaders/AMFLoader.js';
import { GCodeLoader } from 'three/addons/loaders/GCodeLoader.js';
import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

// ── IndexedDB for model storage ──
const DB_NAME = 'ModelLibrary';
const DB_VERSION = 1;
const STORE = 'models';

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE, { keyPath: 'id' });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbGetAll() {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbPut(item) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    const store = tx.objectStore(STORE);
    const req = store.put(item);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

async function dbDelete(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    const store = tx.objectStore(STORE);
    const req = store.delete(id);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

// ── Three.js Loaders ──
const LOADERS = {
  stl:  () => new STLLoader(),
  '3mf': () => new ThreeMFLoader(),
  amf:  () => new AMFLoader(),
  gcode: () => new GCodeLoader(),
  obj:  () => new OBJLoader(),
};

const SUPPORTED_EXT = Object.keys(LOADERS);

function getExt(filename) {
  const parts = filename.toLowerCase().split('.');
  let ext = parts.pop();
  if (ext === 'zip' && parts.length) ext = parts.pop();
  return ext;
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

// ── Parse model data into a Three.js object ──
function parseModel(ext, arrayBuffer) {
  const loader = LOADERS[ext]?.();
  if (!loader) throw new Error('Unsupported format: ' + ext);

  let object;
  if (ext === 'stl') {
    const geometry = loader.parse(arrayBuffer);
    const material = new THREE.MeshStandardMaterial({
      color: 0xf59e0b,
      metalness: 0.2,
      roughness: 0.6,
    });
    object = new THREE.Mesh(geometry, material);
  } else if (ext === 'gcode') {
    const text = new TextDecoder().decode(arrayBuffer);
    object = loader.parse(text);
    object.rotation.x = -Math.PI / 2;
  } else {
    object = loader.parse(arrayBuffer);
  }
  return object;
}

// ── Setup a Three.js scene for rendering ──
function createScene() {
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x09090b);

  // Lighting
  const ambient = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambient);
  const dir1 = new THREE.DirectionalLight(0xffffff, 0.8);
  dir1.position.set(5, 10, 7);
  scene.add(dir1);
  const dir2 = new THREE.DirectionalLight(0xffffff, 0.3);
  dir2.position.set(-5, -3, -5);
  scene.add(dir2);

  return scene;
}

function fitCameraToObject(camera, object, controls) {
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());

  const maxDim = Math.max(size.x, size.y, size.z);
  const fov = camera.fov * (Math.PI / 180);
  let distance = maxDim / (2 * Math.tan(fov / 2));
  distance *= 1.6;

  camera.position.set(
    center.x + distance * 0.5,
    center.y + distance * 0.7,
    center.z + distance
  );
  camera.near = distance / 100;
  camera.far = distance * 100;
  camera.updateProjectionMatrix();

  if (controls) {
    controls.target.copy(center);
    controls.update();
  }

  return { center, size, maxDim };
}

// ── Grid helper ──
function addGrid(scene, size) {
  const maxDim = Math.max(size.x, size.y, size.z);
  let gridSize = 10;
  let divisions = 10;
  if (maxDim > 50) { gridSize = Math.ceil(maxDim / 10) * 10 * 2; divisions = 20; }
  else if (maxDim > 10) { gridSize = 100; divisions = 10; }
  const grid = new THREE.GridHelper(gridSize, divisions, 0x3f3f46, 0x27272a);
  scene.add(grid);
}

// ── Thumbnail Renderer ──
let thumbRenderer = null;

function renderThumbnail(arrayBuffer, ext) {
  return new Promise((resolve) => {
    try {
      const object = parseModel(ext, arrayBuffer);

      if (!thumbRenderer) {
        thumbRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      }
      thumbRenderer.setSize(400, 300);
      thumbRenderer.setPixelRatio(1);

      const scene = createScene();
      scene.add(object);

      const camera = new THREE.PerspectiveCamera(45, 400 / 300, 0.1, 10000);
      fitCameraToObject(camera, object, null);
      thumbRenderer.render(scene, camera);

      resolve(thumbRenderer.domElement.toDataURL('image/png'));

      // Cleanup
      scene.traverse(child => {
        if (child.geometry) child.geometry.dispose();
        if (child.material) {
          if (Array.isArray(child.material)) child.material.forEach(m => m.dispose());
          else child.material.dispose();
        }
      });
    } catch (e) {
      console.warn('Thumbnail failed:', e);
      resolve(null);
    }
  });
}

// ── State ──
let models = [];
let currentViewerId = null;
let viewerRenderer = null;
let viewerControls = null;
let viewerAnimId = null;

// ── DOM refs ──
const grid = document.getElementById('model-grid');
const emptyState = document.getElementById('empty-state');
const modelCount = document.getElementById('model-count');
const fileInput = document.getElementById('file-input');
const btnUpload = document.getElementById('btn-upload');
const viewerPanel = document.getElementById('viewer-panel');
const viewerCanvas = document.getElementById('viewer-canvas');
const viewerName = document.getElementById('viewer-name');
const viewerExt = document.getElementById('viewer-ext');
const viewerInfo = document.getElementById('viewer-info');
const viewerLoading = document.getElementById('viewer-loading');
const btnViewerClose = document.getElementById('btn-viewer-close');
const btnViewerRename = document.getElementById('btn-viewer-rename');
const btnViewerDelete = document.getElementById('btn-viewer-delete');
const dropOverlay = document.getElementById('drop-overlay');
const renameModal = document.getElementById('rename-modal');
const renameInput = document.getElementById('rename-input');
const renameCancel = document.getElementById('rename-cancel');
const renameSave = document.getElementById('rename-save');

// ── Render Library ──
function renderLibrary() {
  const count = models.length;
  modelCount.textContent = count ? `${count} model${count !== 1 ? 's' : ''}` : '';
  emptyState.style.display = count ? 'none' : 'flex';
  grid.style.display = count ? 'grid' : 'none';

  grid.innerHTML = '';
  // Sort by date added (newest first)
  const sorted = [...models].sort((a, b) => b.addedAt - a.addedAt);

  for (const m of sorted) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-thumb">
        ${m.thumbnail
          ? `<img src="${m.thumbnail}" style="width:100%;height:100%;object-fit:contain" alt="${m.name}">`
          : `<div class="placeholder-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>`
        }
      </div>
      <div class="card-body">
        <div class="card-name" title="${m.name}">${m.name}</div>
        <div class="card-meta">
          <span class="card-ext">${m.ext}</span>
          <span class="card-size">${formatSize(m.size)}</span>
        </div>
      </div>
      <div class="card-actions">
        <button class="btn-icon" data-action="rename" data-id="${m.id}" title="Rename">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn-icon" data-action="delete" data-id="${m.id}" title="Delete">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
    `;

    // Click card to open viewer
    card.querySelector('.card-thumb').addEventListener('click', () => openViewer(m.id));
    card.querySelector('.card-body').addEventListener('click', () => openViewer(m.id));

    // Action buttons
    card.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action === 'rename') showRenameModal(id);
        else if (action === 'delete') deleteModel(id);
      });
    });

    grid.appendChild(card);
  }
}

// ── Upload Files ──
async function handleFiles(fileList) {
  for (const file of fileList) {
    const ext = getExt(file.name);
    if (!SUPPORTED_EXT.includes(ext)) {
      console.warn('Unsupported file:', file.name);
      continue;
    }

    const arrayBuffer = await file.arrayBuffer();
    const thumbnail = await renderThumbnail(arrayBuffer, ext);
    const baseName = file.name.replace(/\.[^.]+$/, '');

    const model = {
      id: generateId(),
      name: baseName,
      ext,
      size: file.size,
      data: arrayBuffer,
      thumbnail,
      addedAt: Date.now(),
    };

    await dbPut(model);
    models.push(model);
  }
  renderLibrary();
}

// ── Delete ──
async function deleteModel(id) {
  if (!confirm('Delete this model?')) return;
  await dbDelete(id);
  models = models.filter(m => m.id !== id);
  if (currentViewerId === id) closeViewer();
  renderLibrary();
}

// ── Rename ──
let renameTargetId = null;
function showRenameModal(id) {
  renameTargetId = id;
  const m = models.find(m => m.id === id);
  if (!m) return;
  renameInput.value = m.name;
  renameModal.classList.add('active');
  renameInput.focus();
  renameInput.select();
}

async function doRename() {
  const newName = renameInput.value.trim();
  if (!newName || !renameTargetId) return;
  const m = models.find(m => m.id === renameTargetId);
  if (!m) return;
  m.name = newName;
  await dbPut(m);
  renameModal.classList.remove('active');
  renameTargetId = null;
  renderLibrary();
  if (currentViewerId === m.id) viewerName.textContent = newName;
}

// ── Viewer ──
function openViewer(id) {
  const m = models.find(m => m.id === id);
  if (!m) return;
  currentViewerId = id;
  viewerName.textContent = m.name;
  viewerExt.textContent = m.ext.toUpperCase();
  viewerLoading.style.display = 'flex';
  viewerInfo.textContent = '';
  viewerPanel.classList.add('active');

  // Clean up previous
  disposeViewer();

  requestAnimationFrame(() => {
    try {
      const object = parseModel(m.ext, m.data);
      const scene = createScene();

      // Grid
      const tmpBox = new THREE.Box3().setFromObject(object);
      addGrid(scene, tmpBox.getSize(new THREE.Vector3()));

      scene.add(object);

      const w = viewerCanvas.clientWidth;
      const h = viewerCanvas.clientHeight;
      const camera = new THREE.PerspectiveCamera(45, w / h, 0.01, 100000);

      viewerRenderer = new THREE.WebGLRenderer({ antialias: true });
      viewerRenderer.setSize(w, h);
      viewerRenderer.setPixelRatio(window.devicePixelRatio);
      viewerRenderer.setClearColor(0x09090b);
      viewerCanvas.appendChild(viewerRenderer.domElement);

      viewerControls = new OrbitControls(camera, viewerRenderer.domElement);
      viewerControls.enableDamping = true;
      viewerControls.dampingFactor = 0.1;

      const info = fitCameraToObject(camera, object, viewerControls);

      // Info bar
      const box = new THREE.Box3().setFromObject(object);
      const sz = box.getSize(new THREE.Vector3());
      let triCount = 0;
      object.traverse(child => {
        if (child.geometry) {
          const idx = child.geometry.index;
          triCount += idx ? idx.count / 3 : (child.geometry.attributes.position?.count || 0) / 3;
        }
      });
      viewerInfo.textContent = `Size: ${sz.x.toFixed(1)} x ${sz.y.toFixed(1)} x ${sz.z.toFixed(1)} mm | Triangles: ${Math.round(triCount).toLocaleString()} | File: ${formatSize(m.size)}`;

      viewerLoading.style.display = 'none';

      function animate() {
        viewerAnimId = requestAnimationFrame(animate);
        viewerControls.update();
        viewerRenderer.render(scene, camera);
      }
      animate();

      // Resize handler
      const onResize = () => {
        const w2 = viewerCanvas.clientWidth;
        const h2 = viewerCanvas.clientHeight;
        camera.aspect = w2 / h2;
        camera.updateProjectionMatrix();
        viewerRenderer.setSize(w2, h2);
      };
      window.addEventListener('resize', onResize);
      viewerRenderer._onResize = onResize;

    } catch (e) {
      console.error('Viewer error:', e);
      viewerLoading.style.display = 'none';
      viewerInfo.textContent = 'Error loading model: ' + e.message;
    }
  });
}

function disposeViewer() {
  if (viewerAnimId) cancelAnimationFrame(viewerAnimId);
  viewerAnimId = null;
  if (viewerRenderer) {
    if (viewerRenderer._onResize) window.removeEventListener('resize', viewerRenderer._onResize);
    viewerRenderer.dispose();
    if (viewerRenderer.domElement.parentNode) {
      viewerRenderer.domElement.parentNode.removeChild(viewerRenderer.domElement);
    }
    viewerRenderer = null;
  }
  if (viewerControls) {
    viewerControls.dispose();
    viewerControls = null;
  }
}

function closeViewer() {
  disposeViewer();
  currentViewerId = null;
  viewerPanel.classList.remove('active');
}

// ── Event Listeners ──
btnUpload.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => {
  if (e.target.files.length) handleFiles(e.target.files);
  fileInput.value = '';
});

btnViewerClose.addEventListener('click', closeViewer);
btnViewerRename.addEventListener('click', () => { if (currentViewerId) showRenameModal(currentViewerId); });
btnViewerDelete.addEventListener('click', () => { if (currentViewerId) deleteModel(currentViewerId); });

renameCancel.addEventListener('click', () => { renameModal.classList.remove('active'); });
renameSave.addEventListener('click', doRename);
renameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doRename(); if (e.key === 'Escape') renameModal.classList.remove('active'); });

// Escape key to close viewer
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (renameModal.classList.contains('active')) renameModal.classList.remove('active');
    else if (viewerPanel.classList.contains('active')) closeViewer();
  }
});

// Drag and drop
let dragCounter = 0;
document.addEventListener('dragenter', (e) => {
  e.preventDefault();
  dragCounter++;
  dropOverlay.classList.add('active');
});
document.addEventListener('dragleave', (e) => {
  e.preventDefault();
  dragCounter--;
  if (dragCounter <= 0) {
    dragCounter = 0;
    dropOverlay.classList.remove('active');
  }
});
document.addEventListener('dragover', (e) => e.preventDefault());
document.addEventListener('drop', (e) => {
  e.preventDefault();
  dragCounter = 0;
  dropOverlay.classList.remove('active');
  if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
});

// ── Init ──
(async () => {
  try {
    models = await dbGetAll();
  } catch (e) {
    console.error('DB error:', e);
    models = [];
  }
  renderLibrary();
})();
</script>
</body>
</html>
